var Je=Object.defineProperty;var He=r=>{throw TypeError(r)};var Ze=(r,e,t)=>e in r?Je(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var u=(r,e,t)=>Ze(r,typeof e!="symbol"?e+"":e,t),Re=(r,e,t)=>e.has(r)||He("Cannot "+t);var n=(r,e,t)=>(Re(r,e,"read from private field"),t?t.call(r):e.get(r)),l=(r,e,t)=>e.has(r)?He("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(r):e.set(r,t),c=(r,e,t,s)=>(Re(r,e,"write to private field"),s?s.call(r,t):e.set(r,t),t),U=(r,e,t)=>(Re(r,e,"access private method"),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const h of o.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&s(h)}).observe(document,{childList:!0,subtree:!0});function t(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(i){if(i.ep)return;i.ep=!0;const o=t(i);fetch(i.href,o)}})();var Xe=Object.defineProperty,et=(r,e)=>{for(var t in e)Xe(r,t,{get:e[t],enumerable:!0,configurable:!0,set:s=>e[t]=()=>s})},tt={};et(tt,{slotTypes:()=>Ee,permissions:()=>st,itemsHandlingFlags:()=>Ne,itemClassifications:()=>O,clientStatuses:()=>Ue});var Ue={disconnected:0,connected:5,ready:10,playing:20,goal:30},O={progression:1,useful:2,trap:4,none:0},Ne={minimal:0,others:1,own:2,starting:4,all:7},st={disabled:0,enabled:1,goal:2,auto:6,autoEnabled:7},Ee={spectator:0,player:1,group:2};class Q extends Error{}class it extends Error{constructor(t,s,i){super(t);u(this,"argumentName");u(this,"value");this.argumentName=s,this.value=structuredClone(i)}}class nt extends Error{constructor(t,s){super(t);u(this,"errors",[]);this.errors=s}}class A extends Error{}var $e={timeout:1e4,autoFetchDataPackage:!0,maximumMessages:1e3,debugLogVersions:!0},ot={major:0,minor:5,build:1},at="2.0.4";function qe(){const r=[];for(let e=0;e<36;e++)r.push(Math.floor(Math.random()*16));return r[14]=4,r[19]=r[19]&=-5,r[19]=r[19]|=8,r[8]=r[13]=r[18]=r[23]="-",r.map(e=>e.toString(16)).join("")}var Be={password:"",uuid:qe(),tags:[],version:ot,items:Ne.all,slotData:!0},Y,P,le,de;class K{constructor(e,t,s,i){l(this,Y);l(this,P);l(this,le);l(this,de);c(this,Y,e),c(this,P,t),c(this,le,s),c(this,de,i)}toString(){return this.name}get receiver(){return n(this,de)}get sender(){return n(this,le)}get name(){return n(this,Y).package.lookupItemName(this.game,n(this,P).item,!0)}get id(){return n(this,P).item}get locationName(){return n(this,Y).package.lookupLocationName(this.sender.game,n(this,P).location,!0)}get locationId(){return n(this,P).location}get locationGame(){return this.sender.game}get game(){return this.receiver.game}get progression(){return(this.flags&O.progression)===O.progression}get useful(){return(this.flags&O.useful)===O.useful}get trap(){return(this.flags&O.trap)===O.trap}get filler(){return this.flags===O.none}get flags(){return n(this,P).flags}}Y=new WeakMap,P=new WeakMap,le=new WeakMap,de=new WeakMap;class We{constructor(e,t){u(this,"game");u(this,"checksum");u(this,"itemTable");u(this,"locationTable");u(this,"reverseItemTable");u(this,"reverseLocationTable");this.game=e,this.checksum=t.checksum,this.itemTable=Object.freeze(t.item_name_to_id),this.locationTable=Object.freeze(t.location_name_to_id),this.reverseItemTable=Object.freeze(Object.fromEntries(Object.entries(this.itemTable).map(([s,i])=>[i,s]))),this.reverseLocationTable=Object.freeze(Object.fromEntries(Object.entries(this.locationTable).map(([s,i])=>[i,s])))}exportPackage(){return{checksum:this.checksum,item_name_to_id:{...this.itemTable},location_name_to_id:{...this.locationTable}}}}var J,L,N,q,Te,Ge;class rt{constructor(e){l(this,Te);l(this,J);l(this,L,new Map);l(this,N,new Map);l(this,q,new Set);c(this,J,e),n(this,J).socket.on("roomInfo",t=>{n(this,L).clear(),n(this,N).clear(),n(this,q).clear(),n(this,L).set("Archipelago",U(this,Te,Ge).call(this));for(const s in t.datapackage_checksums)n(this,N).set(s,t.datapackage_checksums[s]),n(this,q).add(s)})}findPackage(e){return n(this,L).get(e)??null}async fetchPackage(e=[],t=!0){e.length===0&&(e=Array.from(n(this,q))),e=e.filter(i=>{var o;return n(this,q).has(i)?((o=n(this,L).get(i))==null?void 0:o.checksum)!==n(this,N).get(i):!1});const s={games:{}};for(const i of e){const o={cmd:"GetDataPackage",games:[i]},[h]=await n(this,J).socket.send(o).wait("dataPackage");s.games[i]=h.data.games[i]}return t&&this.importPackage(s),s}importPackage(e){for(const t in e.games)n(this,L).set(t,new We(t,e.games[t])),n(this,N).set(t,e.games[t].checksum)}exportPackage(){return{games:n(this,L).entries().reduce((e,[t,s])=>(e[t]=s.exportPackage(),e),{})}}lookupItemName(e,t,s=!0){const i=`Unknown Item ${t}`,o=this.findPackage(e);if(!o)return s?i:void 0;const h=o.reverseItemTable[t];return s&&h===void 0?i:h}lookupLocationName(e,t,s=!0){const i=`Unknown Location ${t}`,o=this.findPackage(e);if(!o)return s?i:void 0;const h=o.reverseLocationTable[t];return s&&h===void 0?i:h}}J=new WeakMap,L=new WeakMap,N=new WeakMap,q=new WeakMap,Te=new WeakSet,Ge=function(){return new We("Archipelago",{checksum:"ac9141e9ad0318df2fa27da5f20c50a842afeecb",item_name_to_id:{Nothing:-1},location_name_to_id:{"Cheat Console":-1,Server:-2}})};var Z,_,ue,me;class ht{constructor(e,t,s){l(this,Z);l(this,_,[]);l(this,ue);l(this,me);c(this,Z,e),c(this,ue,t),c(this,me,s)}replace(e){return n(this,_).push({operation:"replace",value:e}),this}default(){return n(this,_).push({operation:"default",value:null}),this}add(e){return n(this,_).push({operation:"add",value:e}),this}multiply(e){return n(this,_).push({operation:"mul",value:e}),this}power(e){return n(this,_).push({operation:"pow",value:e}),this}remainder(e){return n(this,_).push({operation:"mod",value:e}),this}floor(){return n(this,_).push({operation:"floor",value:null}),this}ceiling(){return n(this,_).push({operation:"ceil",value:null}),this}max(e){return n(this,_).push({operation:"max",value:e}),this}min(e){return n(this,_).push({operation:"min",value:e}),this}and(e){return n(this,_).push({operation:"and",value:e}),this}or(e){return n(this,_).push({operation:"or",value:e}),this}xor(e){return n(this,_).push({operation:"xor",value:e}),this}leftShift(e){return n(this,_).push({operation:"left_shift",value:e}),this}rightShift(e){return n(this,_).push({operation:"right_shift",value:e}),this}remove(e){return n(this,_).push({operation:"remove",value:e}),this}pop(e){return n(this,_).push({operation:"pop",value:e}),this}update(e){return n(this,_).push({operation:"update",value:e}),this}async commit(e=!1){const t=qe(),s={cmd:"Set",default:n(this,me),key:n(this,ue),operations:n(this,_),want_reply:e,uuid:t};if(n(this,Z).socket.send(s),!e)return;const[i]=await n(this,Z).socket.wait("setReply",o=>o.uuid===t);return i.value}}Z=new WeakMap,_=new WeakMap,ue=new WeakMap,me=new WeakMap;var b,M,z,Oe,je;class ct{constructor(e){l(this,Oe);l(this,b);l(this,M,{});l(this,z,{});c(this,b,e),n(this,b).socket.on("disconnected",()=>{c(this,M,{}),c(this,z,{})}).on("setReply",t=>{n(this,M)[t.key]=t.value;const s=n(this,z)[t.key];s&&s.forEach(i=>i(t.key,t.value,t.original_value))}).on("connected",()=>{if(n(this,b).options.debugLogVersions){const t=`${n(this,b).game}:${at}:${navigator==null?void 0:navigator.userAgent}`;this.prepare("archipelago.js__runtimes",{}).default().update({[t]:!0}).commit(!1)}})}get store(){return structuredClone(n(this,M))}async fetch(e,t=!1){let s=typeof e=="string"?[e]:e;if(t){const o=s.filter(h=>n(this,M)[h]===void 0);o.length>0&&n(this,b).socket.send({cmd:"SetNotify",keys:o})}let i={};if(s=s.filter(o=>{const h=structuredClone(n(this,M)[o]),a=h!==void 0;return a&&(i[o]=h),!a}),s.length>0){const o=await U(this,Oe,je).call(this,s);i={...i,...o}}return t&&c(this,M,{...n(this,M),...i}),typeof e=="string"?i[e]:i}async notify(e,t){return e.forEach(s=>{var i;(i=n(this,z))[s]??(i[s]=[]),n(this,z)[s].push(t)}),this.fetch(e,!0)}prepare(e,t){if(e.startsWith("_read_"))throw TypeError("Cannot manipulate read only keys.");return new ht(n(this,b),e,t)}async fetchItemNameGroups(e){return await this.fetch([`_read_item_name_groups_${e}`],!0)}async fetchLocationNameGroups(e){return await this.fetch([`_read_location_name_groups_${e}`],!0)}}b=new WeakMap,M=new WeakMap,z=new WeakMap,Oe=new WeakSet,je=async function(e){const t=qe(),[s]=await n(this,b).socket.send({cmd:"Get",keys:e,uuid:t}).wait("retrieved",i=>i.uuid===t);return s.keys};var x;class lt{constructor(){l(this,x,{})}addEventListener(e,t,s=!1){var i;(i=n(this,x))[e]??(i[e]=[]),n(this,x)[e].push([t,s])}removeEventListener(e,t){const s=n(this,x)[e];s&&s.length>0&&(n(this,x)[e]=s.filter(([i])=>i!==t))}dispatchEvent(e,t){const s=n(this,x)[e]??[];for(const[i,o]of s)i(...t),o&&this.removeEventListener(e,i)}}x=new WeakMap;var D;class he{constructor(){l(this,D,new lt)}on(e,t){return n(this,D).addEventListener(e,t),this}off(e,t){return n(this,D).removeEventListener(e,t),this}async wait(e,t=()=>!0){return new Promise(s=>{const i=(...o)=>{t(...o)&&(n(this,D).removeEventListener(e,i),s(o))};n(this,D).addEventListener(e,i)})}emit(e,t){n(this,D).dispatchEvent(e,t)}}D=new WeakMap;var v,H;class dt extends he{constructor(t){super();l(this,v);l(this,H,Number.MIN_SAFE_INTEGER);c(this,v,t),n(this,v).socket.on("bounced",s=>{var i;if((i=s.tags)!=null&&i.includes("DeathLink")&&s.data.time&&s.data.source){const o=s.data;if(o.time===n(this,H))return;c(this,H,o.time),this.emit("deathReceived",[o.source,o.time*1e3,o.cause])}})}get enabled(){return n(this,v).arguments.tags.includes("DeathLink")}enableDeathLink(){n(this,v).arguments.tags.includes("DeathLink")||n(this,v).updateTags([...n(this,v).arguments.tags,"DeathLink"])}disableDeathLink(){n(this,v).arguments.tags.includes("DeathLink")&&n(this,v).updateTags(n(this,v).arguments.tags.filter(t=>t!=="DeathLink"))}sendDeathLink(t,s){if(!n(this,v).authenticated)throw new A("Cannot send death links before connecting and authenticating.");if(!this.enabled)return;c(this,H,Math.ceil(Date.now()/1e3));const i={source:t,cause:s,time:n(this,H)};n(this,v).bounce({tags:["DeathLink"]},i)}}v=new WeakMap,H=new WeakMap;var $,X,ge;class Pe{constructor(e,t){l(this,$);l(this,X);l(this,ge);c(this,$,e),c(this,X,t),c(this,ge,new K(n(this,$),{item:t.item,location:t.location,player:t.finding_player,flags:t.item_flags},n(this,$).players.findPlayer(t.finding_player),n(this,$).players.findPlayer(t.receiving_player)))}get item(){return n(this,ge)}get found(){return n(this,X).found}get entrance(){return n(this,X).entrance||"Vanilla"}}$=new WeakMap,X=new WeakMap,ge=new WeakMap;var S,F,k,Ae,Ve;class ut extends he{constructor(t){super();l(this,Ae);l(this,S);l(this,F,[]);l(this,k,[]);c(this,S,t),n(this,S).socket.on("receivedItems",s=>{let i=s.index;const o=s.items.length,h=[...s.items];for(;h.length>0;){const a=h.shift();n(this,F)[i++]=new K(n(this,S),a,n(this,S).players.findPlayer(a.player),n(this,S).players.self)}this.emit("itemsReceived",[n(this,F).slice(s.index,s.index+o),s.index])}).on("connected",()=>{c(this,k,[]),c(this,F,[]),n(this,S).storage.notify([`_read_hints_${n(this,S).players.self.team}_${n(this,S).players.self.slot}`],U(this,Ae,Ve).bind(this)).then(s=>{const i=s[`_read_hints_${n(this,S).players.self.team}_${n(this,S).players.self.slot}`];c(this,k,i.map(o=>new Pe(n(this,S),o))),this.emit("hintsInitialized",[n(this,k)])}).catch(s=>{throw s})})}get received(){return[...n(this,F)]}get hints(){return[...n(this,k)]}get count(){return n(this,F).length}}S=new WeakMap,F=new WeakMap,k=new WeakMap,Ae=new WeakSet,Ve=function(t,s){for(let i=0;i<s.length;i++)n(this,k)[i]===void 0?(n(this,k)[i]=new Pe(n(this,S),s[i]),this.emit("hintReceived",[n(this,k)[i]])):n(this,k)[i].found!==s[i].found&&(n(this,k)[i]=new Pe(n(this,S),s[i]),this.emit("hintFound",[n(this,k)[i]]))};class be{constructor(e,t){u(this,"client");u(this,"part");this.client=e,this.part=t}toString(){return this.text}}class mt extends be{constructor(t,s,i,o){super(t,s);u(this,"part");u(this,"type","item");u(this,"item");const h=t.players.findPlayer(s.player,o.team);this.part=s,this.item=new K(t,i,h,o)}get text(){return this.item.name}}var ee;class gt extends be{constructor(t,s){super(t,s);l(this,ee);u(this,"part");u(this,"type","location");u(this,"id");const i=t.players.findPlayer(s.player),o=t.package.findPackage(i.game);this.part=s,s.type==="location_name"?(c(this,ee,s.text),this.id=o.locationTable[s.text]):(this.id=parseInt(s.text),c(this,ee,t.package.lookupLocationName(i.game,this.id,!0)))}get text(){return n(this,ee)}}ee=new WeakMap;class pt extends be{constructor(t,s){super(t,s);u(this,"part");u(this,"type","color");u(this,"color");this.part=s,this.color=s.color}get text(){return this.part.text}}class ft extends be{constructor(t,s){super(t,s);u(this,"part");u(this,"type");this.part=s,this.part.type==="entrance_name"?this.type="entrance":this.type="text"}get text(){return this.part.text}}class _t extends be{constructor(t,s){super(t,s);u(this,"part");u(this,"type","player");u(this,"player");if(this.part=s,s.type==="player_id")this.player=t.players.findPlayer(parseInt(s.text));else{const i=t.players.teams[t.players.self.team].find(o=>o.name===s.text);if(!i)throw new Error(`Cannot find player under name: ${s.text}`);this.player=i}}get text(){return this.player.alias}}var m,xe,De,Ke;class yt extends he{constructor(t){super();l(this,De);l(this,m);l(this,xe,[]);c(this,m,t),n(this,m).socket.on("printJSON",U(this,De,Ke).bind(this))}get log(){return[...n(this,xe)]}async say(t){if(!n(this,m).authenticated)throw new A("Cannot send chat messages without being authenticated.");t=t.trim();const s={cmd:"Say",text:t};n(this,m).socket.send(s),await this.wait("chat",i=>i===t)}}m=new WeakMap,xe=new WeakMap,De=new WeakSet,Ke=function(t){const s=[];for(const o of t.data)switch(o.type){case"item_id":case"item_name":{const h=t;let a;h.type==="ItemCheat"?a=n(this,m).players.findPlayer(h.receiving,h.team):a=n(this,m).players.findPlayer(h.receiving),s.push(new mt(n(this,m),o,h.item,a));break}case"location_id":case"location_name":{s.push(new gt(n(this,m),o));break}case"color":{s.push(new pt(n(this,m),o));break}case"player_id":case"player_name":{s.push(new _t(n(this,m),o));break}default:{s.push(new ft(n(this,m),o));break}}const i=s.map(o=>o.text).join();switch(n(this,m).options.maximumMessages>=1&&(this.log.push({text:i,nodes:s}),this.log.splice(0,this.log.length-n(this,m).options.maximumMessages)),t.type){case"ItemSend":{const o=n(this,m).players.findPlayer(t.item.player),h=n(this,m).players.findPlayer(t.receiving),a=new K(n(this,m),t.item,o,h);this.emit("itemSent",[i,a,s]);break}case"ItemCheat":{const o=n(this,m).players.findPlayer(t.item.player,t.team),h=n(this,m).players.findPlayer(t.receiving,t.team),a=new K(n(this,m),t.item,o,h);this.emit("itemCheated",[i,a,s]);break}case"Hint":{const o=n(this,m).players.findPlayer(t.item.player),h=n(this,m).players.findPlayer(t.receiving),a=new K(n(this,m),t.item,o,h);this.emit("itemHinted",[i,a,t.found,s]);break}case"Join":{const o=n(this,m).players.findPlayer(t.slot,t.team);this.emit("connected",[i,o,t.tags,s]);break}case"Part":{const o=n(this,m).players.findPlayer(t.slot,t.team);this.emit("disconnected",[i,o,s]);break}case"Chat":{const o=n(this,m).players.findPlayer(t.slot,t.team);this.emit("chat",[t.message,o,s]);break}case"ServerChat":{this.emit("serverChat",[t.message,s]);break}case"TagsChanged":{const o=n(this,m).players.findPlayer(t.slot,t.team);this.emit("tagsUpdated",[i,o,t.tags,s]);break}case"Tutorial":{this.emit("tutorial",[i,s]);break}case"CommandResult":{this.emit("userCommand",[i,s]);break}case"AdminCommandResult":{this.emit("adminCommand",[i,s]);break}case"Goal":{const o=n(this,m).players.findPlayer(t.slot,t.team);this.emit("goaled",[i,o,s]);break}case"Release":{const o=n(this,m).players.findPlayer(t.slot,t.team);this.emit("released",[i,o,s]);break}case"Collect":{const o=n(this,m).players.findPlayer(t.slot,t.team);this.emit("collected",[i,o,s]);break}case"Countdown":this.emit("countdown",[i,t.countdown,s])}this.emit("message",[i,s])};var C,R,te,Le;class Me{constructor(e,t){l(this,te);l(this,C);l(this,R);c(this,C,e),c(this,R,t)}toString(){return this.alias}get name(){return n(this,R).name}get alias(){return n(this,R).alias}get game(){return this.slot===0?"Archipelago":n(this,te,Le).game}get type(){return this.slot===0?Ee.spectator:n(this,te,Le).type}get team(){return n(this,R).team}get slot(){return n(this,R).slot}get members(){return this.type!==Ee.group?[]:n(this,C).players.teams[this.team].filter(e=>n(this,te,Le).group_members.includes(e.slot))}get groups(){return this.slot===0?[]:n(this,C).players.teams[this.team].filter(e=>e.slot!==0&&n(this,C).players.slots[e.slot].group_members.includes(this.slot))}async fetchStatus(){return this.type===Ee.group?Ue.goal:await n(this,C).storage.fetch(`_read_client_status_${this.team}_${this.slot}`)??0}async fetchSlotData(){return await n(this,C).storage.fetch(`_read_slot_data_${this.slot}`)}async fetchHints(){return(await n(this,C).storage.fetch(`_read_hints_${this.team}_${this.slot}`)).map(t=>new Pe(n(this,C),t))}}C=new WeakMap,R=new WeakMap,te=new WeakSet,Le=function(){return n(this,C).players.slots[this.slot]};var E,I,pe,se,fe;class St extends he{constructor(t){super();l(this,E);l(this,I,[]);l(this,pe,{});l(this,se,0);l(this,fe,0);c(this,E,t),n(this,E).socket.on("connected",s=>{var i,o;c(this,pe,Object.freeze(s.slot_info)),c(this,I,[]),c(this,se,s.slot),c(this,fe,s.team);for(const h of s.players)(i=n(this,I))[o=h.team]??(i[o]=[{team:h.team,slot:0,name:"Archipelago",alias:"Archipelago"}]),n(this,I)[h.team][h.slot]=h}).on("roomUpdate",s=>{if(s.players){for(const i of s.players)if(n(this,I)[i.team][i.slot].alias!==i.alias){const o=n(this,I)[i.team][i.slot].alias;n(this,I)[i.team][i.slot]=i,this.emit("aliasUpdated",[new Me(n(this,E),i),o,i.alias])}}})}get self(){if(n(this,se)===0)throw new Error("Cannot lookup own player object when client has never connected to a server.");return new Me(n(this,E),n(this,I)[n(this,fe)][n(this,se)])}get slots(){return n(this,pe)}get teams(){const t=[];for(let s=0;s<n(this,I).length;s++){t[s]=[];for(let i=0;i<n(this,I)[s].length;i++)t[s].push(new Me(n(this,E),n(this,I)[s][i]))}return t}findPlayer(t,s){if(s===void 0&&(s=n(this,E).players.self.team),n(this,I)[s])return new Me(n(this,E),n(this,I)[s][t])}}E=new WeakMap,I=new WeakMap,pe=new WeakMap,se=new WeakMap,fe=new WeakMap;var _e,ye,Se,we,Ie,ve,ie,W,ne,G,j,V,B,Fe;class wt extends he{constructor(t){super();l(this,_e);l(this,ye,{major:-1,minor:-1,build:-1});l(this,Se,{major:-1,minor:-1,build:-1});l(this,we,[]);l(this,Ie,[]);l(this,ve,"");l(this,ie,!1);l(this,W,0);l(this,ne,0);l(this,G,0);l(this,j,{release:0,collect:0,remaining:0});l(this,V,[]);l(this,B,[]);l(this,Fe,!1);c(this,_e,t),n(this,_e).socket.on("roomInfo",s=>{c(this,ye,{major:s.version.major,minor:s.version.minor,build:s.version.build}),c(this,Se,{major:s.generator_version.major,minor:s.generator_version.minor,build:s.generator_version.build}),c(this,Ie,s.tags),c(this,we,s.games),c(this,ve,s.seed_name),c(this,ie,s.password),c(this,j,s.permissions),c(this,ne,s.hint_cost),c(this,G,s.location_check_points)}).on("connected",s=>{c(this,V,s.missing_locations),c(this,B,s.checked_locations),this.emit("locationsChecked",[this.checkedLocations]),c(this,W,s.hint_points),this.emit("hintPointsUpdated",[0,s.hint_points])}).on("roomUpdate",s=>{if(s.hint_cost!==void 0){const[i,o]=[this.hintCost,this.hintCostPercentage];c(this,ne,s.hint_cost),this.emit("hintCostUpdated",[i,this.hintCost,o,this.hintCostPercentage])}if(s.hint_points!==void 0){const i=n(this,W);c(this,W,s.hint_points),this.emit("hintPointsUpdated",[i,this.hintPoints])}if(s.location_check_points!==void 0){const i=n(this,G);c(this,G,s.location_check_points),this.emit("locationCheckPointsUpdated",[i,this.locationCheckPoints])}if(s.password!==void 0&&(c(this,ie,s.password),this.emit("passwordUpdated",[this.password])),s.permissions!==void 0){const i=n(this,j);c(this,j,s.permissions),this.emit("permissionsUpdated",[i,this.permissions])}s.checked_locations!==void 0&&(c(this,B,[...n(this,B),...s.checked_locations]),c(this,V,this.missingLocations.filter(i=>{var o;return!((o=s.checked_locations)!=null&&o.includes(i))})),this.emit("locationsChecked",[s.checked_locations]))})}get serverVersion(){return{...n(this,ye)}}get generatorVersion(){return{...n(this,Se)}}get games(){return[...n(this,we)]}get tags(){return[...n(this,Ie)]}get seedName(){return n(this,ve)}get password(){return n(this,ie)}get permissions(){return{...n(this,j)}}get hintPoints(){return n(this,W)}get hintCost(){return this.hintCostPercentage>0?Math.max(1,Math.floor(this.hintCostPercentage*this.allLocations.length*.01)):0}get hintCostPercentage(){return n(this,ne)}get locationCheckPoints(){return n(this,G)}get missingLocations(){return[...n(this,V)].sort()}get checkedLocations(){return[...n(this,B)].sort()}get allLocations(){return[...n(this,V),...n(this,B)].sort()}get race(){return n(this,Fe)}}_e=new WeakMap,ye=new WeakMap,Se=new WeakMap,we=new WeakMap,Ie=new WeakMap,ve=new WeakMap,ie=new WeakMap,W=new WeakMap,ne=new WeakMap,G=new WeakMap,j=new WeakMap,V=new WeakMap,B=new WeakMap,Fe=new WeakMap;var w,oe,re,Qe,Ye;class It extends he{constructor(){super();l(this,re);l(this,w,null);l(this,oe,!1)}get connected(){return n(this,oe)}get url(){var t;return((t=n(this,w))==null?void 0:t.url)??""}send(...t){if(n(this,w))return n(this,w).send(JSON.stringify(t)),this.emit("sentPackets",[t]),this;throw new Q("Unable to send packets to the server; not connected to a server.")}async connect(t){if(this.disconnect(),typeof t=="string"){if(!/^([a-zA-Z]+:)\/\/[A-Za-z0-9_.~\-:]+/i.test(t))try{return await this.connect(new URL(`wss://${t}`))}catch{return await this.connect(new URL(`ws://${t}`))}t=new URL(t)}if(t.port=t.port||"38281",t.protocol!=="wss:"&&t.protocol!=="ws:")throw new TypeError("Unexpected protocol. Archipelago only supports the ws:// and wss:// protocols.");try{return new Promise((s,i)=>{const o=U(this,re,Ye).call(this);if(o===null)throw new Q("Unable to find a suitable WebSocket API in the current runtime.");c(this,w,new o(t)),n(this,w).onmessage=U(this,re,Qe).bind(this),n(this,w).onclose=()=>{this.disconnect(),i(new Q("Failed to connect to Archipelago server."))},n(this,w).onerror=()=>{this.disconnect(),i(new Q("Failed to connect to Archipelago server."))},n(this,w).onopen=()=>{this.wait("roomInfo").then(([h])=>{if(c(this,oe,!0),n(this,w)){n(this,w).onclose=this.disconnect.bind(this),n(this,w).onerror=this.disconnect.bind(this),s(h);return}this.disconnect(),i(new Q("Failed to connect to Archipelago server."))}).catch(h=>{throw h})}})}catch(s){throw this.disconnect(),s}}disconnect(){var t;this.connected&&(c(this,oe,!1),(t=n(this,w))==null||t.close(),c(this,w,null),this.emit("disconnected",[]))}}w=new WeakMap,oe=new WeakMap,re=new WeakSet,Qe=function(t){const s=JSON.parse(t.data);for(const i of s){switch(i.cmd){case"ConnectionRefused":this.emit("connectionRefused",[i]);break;case"Bounced":this.emit("bounced",[i,i.data]);break;case"Connected":this.emit("connected",[i]);break;case"DataPackage":this.emit("dataPackage",[i]);break;case"InvalidPacket":this.emit("invalidPacket",[i]);break;case"LocationInfo":this.emit("locationInfo",[i]);break;case"PrintJSON":this.emit("printJSON",[i]);break;case"ReceivedItems":this.emit("receivedItems",[i]);break;case"Retrieved":this.emit("retrieved",[i]);break;case"RoomInfo":this.emit("roomInfo",[i]);break;case"RoomUpdate":this.emit("roomUpdate",[i]);break;case"SetReply":this.emit("setReply",[i]);break}this.emit("receivedPacket",[i])}},Ye=function(){let t=null;return typeof window<"u"?t=window.WebSocket||window.MozWebSocket:typeof global<"u"?t=global.WebSocket||global.MozWebSocket:typeof self<"u"?t=self.WebSocket||self.MozWebSocket:typeof WebSocket<"u"?t=WebSocket:typeof MozWebSocket<"u"&&(t=MozWebSocket),t};var ae,T,ke,Ce;class vt{constructor(e){l(this,ae,!1);l(this,T,Be);l(this,ke,"");l(this,Ce,"");u(this,"socket",new It);u(this,"package",new rt(this));u(this,"storage",new ct(this));u(this,"room",new wt(this));u(this,"players",new St(this));u(this,"items",new ut(this));u(this,"messages",new yt(this));u(this,"deathLink",new dt(this));u(this,"options");e?this.options={...$e,...e}:this.options={...$e},this.socket.on("disconnected",()=>{c(this,ae,!1)}).on("sentPackets",t=>{for(const s of t)s.cmd==="ConnectUpdate"&&(n(this,T).tags=s.tags,n(this,T).items=s.items_handling)})}get authenticated(){return this.socket.connected&&n(this,ae)}get name(){return n(this,ke)}get game(){return n(this,Ce)}get arguments(){return{...n(this,T)}}async login(e,t,s="",i){if(t==="")throw new it("Provided slot name cannot be blank.","name",t);i?c(this,T,{...Be,...i}):c(this,T,{...Be});const o=new Set(this.arguments.tags);!s&&!o.has("HintGame")&&!o.has("Tracker")&&!o.has("TextOnly")&&o.add("TextOnly"),n(this,T).tags=Array.from(o);const h={cmd:"Connect",name:t,game:s,password:this.arguments.password,slot_data:this.arguments.slotData,items_handling:this.arguments.items,uuid:this.arguments.uuid,tags:this.arguments.tags,version:{...this.arguments.version,class:"Version"}};return await this.socket.connect(e),this.options.autoFetchDataPackage&&await this.package.fetchPackage(),new Promise((a,d)=>{const g=setTimeout(()=>d(new Q("Server failed to respond in time.")),this.options.timeout),y=f=>{c(this,ae,!0),c(this,Ce,f.slot_info[f.slot].game),c(this,ke,f.slot_info[f.slot].name),this.socket.off("connected",y).off("connectionRefused",p),clearTimeout(g),a(f.slot_data)},p=f=>{var ce;this.socket.off("connected",y).off("connectionRefused",p),clearTimeout(g),d(new nt(`Connection was refused by the server. Reason(s): [${(ce=f.errors)==null?void 0:ce.join(", ")}`,f.errors??[]))};this.socket.on("connected",y.bind(this)).on("connectionRefused",p.bind(this)).send(h)})}updateStatus(e){if(!this.authenticated)throw new A("Cannot update status while not connected and authenticated.");this.socket.send({cmd:"StatusUpdate",status:e})}goal(){this.updateStatus(Ue.goal)}updateTags(e){if(!this.authenticated)throw new A("Cannot update tags while not connected and authenticated.");this.socket.send({cmd:"ConnectUpdate",tags:e,items_handling:this.arguments.items})}updateItemsHandling(e){if(!this.authenticated)throw new A("Cannot update tags while not connected and authenticated.");this.socket.send({cmd:"ConnectUpdate",tags:this.arguments.tags,items_handling:e})}check(...e){if(!this.authenticated)throw new A("Cannot check locations while not connected and authenticated.");e=e.filter(t=>this.room.missingLocations.includes(t)),this.socket.send({cmd:"LocationChecks",locations:e})}async scout(e,t=0){if(!this.authenticated)throw new A("Cannot scout locations while not connected and authenticated.");e=e.filter(i=>this.room.allLocations.includes(i));const[s]=await this.socket.send({cmd:"LocationScouts",create_as_hint:t,locations:e}).wait("locationInfo",i=>i.locations.map(o=>o.location).toSorted().join(",")===e.toSorted().join(","));return s.locations.map(i=>new K(this,i,this.players.self,this.players.findPlayer(i.player)))}bounce(e,t){if(!this.authenticated)throw new A("Cannot send bounces while not connected and authenticated.");this.socket.send({cmd:"Bounce",data:t,games:e.games??[],slots:e.slots??[],tags:e.tags??[]})}}ae=new WeakMap,T=new WeakMap,ke=new WeakMap,Ce=new WeakMap;class kt{constructor(){this.STAGE_COMPLETE_OFFSET=1e4,this.BOOK_OFFSET=10100,this.ENEMY_OFFSET=10200,this.LOC_OFFSET=11e3,this.ITEM_OFFSET=12e3,this.TRAPS_OFFSET=13e3,this.CLASS_OFFSET=14e3,this.RANGER_CLASSES={14e3:"Boxer",14001:"Gladiator",14002:"Sniper",14003:"Magician",14004:"Priest",14005:"Gunner",14006:"Whipper",14007:"Angel"},this.INV_START=16,this.MOUSE_SLOT=40,this.stagesToWin=[88],this._connected=!1,this._disconnected=!1,this.receivedItems=[],this.pendingItems=[],this._serverItemsQueue=[],this.prevStage=[...Stage_Status],this.winReported=!1,this.lastSequence=-1,this.sendShopHints=!1,this.isScouting=!1,this.excludedBookStages=[0,20,47,70,77],this.bookHints={},this.randomizedBookCosts={},this.slotData={},this.deathLinkSent=!1,this.deathLinkReceived=!1,this.deathLinkPending=!1,this.deathLinkSource="",this.deathLinkTime="",this.deathLinkCause="",this.pendingTraps=[],this.deathMouseItem={},this.connectMouseItem={},this.unlockForgetTree=!1,this.host=document.getElementById("host"),this.port=document.getElementById("port"),this.slotName=document.getElementById("slotName"),this.password=document.getElementById("password"),this.connect=document.getElementById("connect"),this.connectionBox=document.getElementById("connectionBox"),this.connectionInfo=document.getElementById("connectionInfo"),this.disconnect=document.getElementById("disconnect"),this.chatLine=document.getElementById("chatLine"),this.message=document.getElementById("message"),this.send=document.getElementById("send"),this.chatMessages=document.getElementById("chatMessages"),this.apDiv=document.getElementById("APConnection"),this.leftPanel=document.getElementById("left-panel"),this.connect.addEventListener("click",()=>this._onConnectClick());const e=o=>{o.addEventListener("keydown",h=>{h.key==="Enter"&&this._onConnectClick()})};e(this.host),e(this.port),e(this.slotName),e(this.password);let t=null,s=!1;const i=()=>{this.disconnect.textContent="Disconnect",this.disconnect.style.color="",s=!1,t&&(clearTimeout(t),t=null)};this.disconnect.addEventListener("click",o=>{var h;s?((h=this.client)==null||h.socket.disconnect(),i()):(this.disconnect.textContent="Are you sure?",this.disconnect.style.color="red",s=!0,t=setTimeout(i,1e4)),o.stopPropagation()}),document.addEventListener("click",o=>{s&&!this.disconnect.contains(o.target)&&i()}),this.send.addEventListener("click",()=>this._onSendClick()),this.message.addEventListener("keydown",o=>{o.key==="Enter"&&this._onSendClick()}),window.addEventListener("beforeunload",()=>this._onUnload()),this._tick=this._tick.bind(this),requestAnimationFrame(this._tick)}getStorageKey(){return`StickRangerSaveData:${this.client.players.self.team}:${this.client.players.self.slot}`}async loadAPData(){console.log("Loading data...");const e=await this.client.storage.fetch(this.getStorageKey(),{});e?(console.log("Found data: ",e),this.receivedItems=e.receivedItems??[],this.prevStage=e.stages??[...Stage_Status],this.bookHints=e.bookHints??{},this.randomizedBookCosts=e.randomizedBookCosts??{},this.deathMouseItem=e.deathMouseItem??{},this.connectMouseItem=e.connectMouseItem??{},window.ArchipelagoMod.enemyIdsSent=new Set(e.enemyIdsSent??[]),window.ArchipelagoMod.pendingClassSwapItems=e.pendingClassSwapItems??[],GameLoad(e.save.replace(/\r\n|\r|\n/g,"")),this.restoreStagesBeaten(e.stages)):console.log("No data found")}async saveAPData(){if(console.log("Saving game..."),this._connected){Save_Code3=genSaveCode(0);const e={receivedItems:this.receivedItems,stages:Stage_Status,save:GameSave("0"),bookHints:this.bookHints,randomizedBookCosts:this.randomizedBookCosts,deathMouseItem:this.deathMouseItem,connectMouseItem:this.connectMouseItem,enemyIdsSent:Array.from(window.ArchipelagoMod.enemyIdsSent??[]),pendingClassSwapItems:window.ArchipelagoMod.pendingClassSwapItems??[]};console.log("Saving payload: "),console.log(e),await this.client.storage.prepare(this.getStorageKey(),{}).update(e).commit(!1)}else console.log("Not connected yet")}async _onConnectClick(){this.leftPanel.style.display="block",this.connectionInfo.textContent="Connected at: "+this.host.value+":"+this.port.value+" - "+this.slotName.value,this._disconnected=!1,this.apDiv.style.display="none",this.connectionBox.style.display="flex",await this._connect()}async _onDisconnect(){this.leftPanel.style.display="none",this._connected=!1,this._disconnected=!0,this.apDiv.style.display="flex",this.connectionBox.style.display="none",this.chatLine.style.display="none",this.log("Disconnected from multiworld server.","info"),Sequence_Step=0;for(var e=0;e<Stage_Count;e++)Stage_Status[e]=0;Stage_Status[0]=Beaten|Unlocked,Stage_Status[1]=Unlocked,antiCheatSet()}_onSendClick(){const e=this.message.value.trim();e.length!==0&&(this.client.messages.say(e),e[0]==="/"&&this.log("Cannot issue command "+e.slice(1).split(" ")[0]+". Client commands are not yet supported."),this.message.value="")}log(e,t="info"){const s=document.createElement("div"),i=document.createElement("span");i.textContent=e,t==="error"&&(i.style.color="red"),s.appendChild(i),s.style.lineHeight="16px",this.chatMessages.append(s),this.chatMessages.scrollTop=this.chatMessages.scrollHeight}isNumber(e){return typeof e=="number"}_onUnload(){var e;(e=this.client)==null||e.socket.disconnect()}restoreStagesBeaten(e){for(let t=0;t<e.length;t++)Stage_Status[t]|=e[t];return antiCheatSet(),Stage_Status}createRandomizedBookCosts(e){const t={},s=Stage_Status.length;switch(e){case 1:{for(let i=0;i<s;i++){const o=100*i,h=4e3*i,a=Math.pow(Math.random(),1.5),d=o+a*(h-o);t[i]=Math.max(1,Math.floor(d))}return t}case 2:{for(let i=0;i<s;i++)t[i]=Math.floor(Math.random()*99999)+1;return t}case 3:{for(let i=0;i<s;i++)t[i]=Math.floor(Math.random()*999999)+1;return t}case 0:default:return{}}}isEmpty(e){for(const t in e)if(Object.hasOwn(e,t))return!1;return!0}die(e,t){this.log(`You died from ${e}'s death${t?`: ${t}`:""}.`,"error");for(let s=0;s<4;s++)LP_Current[s]=0;this.deathLinkSource="",this.deathLinkTime="",this.deathLinkCause="",antiCheatSet()}async _connect(){var a;this.client=new vt;const e=this.host.value,t=parseInt(this.port.value),s="Stick Ranger",i=this.slotName.value,o=this.password.value,h=`${e}:${t}`;this.client.socket.on("receivedItems",async d=>{const g=d.items.map(p=>p.item),y=new Set(this.receivedItems);g.forEach(p=>{this.RANGER_CLASSES[p]&&(y.has(p)||this.receivedItems.push(p),antiCheatSet())}),this._serverItemsQueue.push({index:d.index,items:g})}),this.client.socket.on("locationInfo",d=>{d.locations.forEach(g=>{if(g.location>=this.BOOK_OFFSET&&g.location<this.BOOK_OFFSET+100){const y=g.location-this.BOOK_OFFSET;this.bookHints[y]={player:this.client.players.findPlayer(g.player).name,item:this.client.package.lookupItemName(this.client.players.findPlayer(g.player).game,g.item),itemClassification:g.flags}}})}),this.client.socket.on("printJSON",d=>{const g=document.createElement("div");if(d.item){const y=this.slotData.player_id;d.data.forEach(p=>{var ce;const f=document.createElement("span");if(p.type==="player_id"){const ze=Number(p.text);f.textContent=(ce=this.client.players.findPlayer(ze))==null?void 0:ce.name,ze===y?f.style.color="#ee00ee":f.style.color="#eee8cd"}else if(p.type==="item_id")switch(f.textContent=this.client.package.lookupItemName(this.client.players.findPlayer(p.player).game,Number(p.text)),d.item.flags){case 1:f.style.color="#9f79ee";break;case 2:f.style.color="#4f94cd";break;case 4:f.style.color="#ed7b6e";break;case 0:default:f.style.color="#09cbcb";break}else p.type==="location_id"?(f.textContent=this.client.package.lookupLocationName(this.client.players.findPlayer(p.player).game,Number(p.text)),f.style.color="limegreen"):p.text&&(f.textContent=p.text);g.appendChild(f)})}else if(d.type==="CommandResult"){const y=document.createElement("pre");y.textContent=d.data[0].text,y.style.margin=0,g.appendChild(y)}else{const y=document.createElement("span");y.textContent=d.data[0].text,g.appendChild(y)}g.style.lineHeight="16px",this.chatMessages.appendChild(g),this.chatMessages.scrollTop=this.chatMessages.scrollHeight}),this.client.deathLink.on("deathReceived",(d,g,y)=>{this.deathLinkReceived=!0,this.deathLinkPending=!0,this.deathLinkSource=d,this.deathLinkTime=g,this.deathLinkCause=y}),this.client.socket.on("disconnected",async()=>{this._onDisconnect()}),this.client.socket.on("bounced",d=>{console.warn("Bounced"),console.log(d)}),this.client.socket.on("invalidPacket",d=>{console.warn("Invalid packet"),console.log(d)}),this.client.socket.on("connectionRefused",d=>{d.errors.forEach(g=>{this.log(g+"; please verify your connection settings.","error")})});try{window.ArchipelagoMod.pendingSave=!1,window.ArchipelagoMod.pendingAPItemDrops=[],window.ArchipelagoMod.pendingClassSwapItems=[],this.slotData=await this.client.login(h,i,s,{password:o,itemsHandlingFlags:Ne.all,tags:["AP"],slotData:!0}),console.log("Slot data: ",this.slotData),await this.loadAPData(),this._connected=!0,this.slotData.ranger_class_randomizer==1&&(window.ArchipelagoMod.unlockForgetTree=!0),this.setStagesToWinFromGoal(),window.ArchipelagoMod.rangerClassRandomizer=this.slotData.ranger_class_randomizer??0,window.ArchipelagoMod.rangerClassesUnlocked=this.getUnlockedClasses(),window.ArchipelagoMod.classesForCastle=this.slotData.classes_req_for_castle??2,window.ArchipelagoMod.classesForSubmarineShrine=this.slotData.classes_req_for_submarine_shrine??3,window.ArchipelagoMod.classesForPyramid=this.slotData.classes_req_for_pyramid??4,window.ArchipelagoMod.classesForIceCastle=this.slotData.classes_req_for_ice_castle??5,window.ArchipelagoMod.classesForHellCastle=this.slotData.classes_req_for_hell_castle??6,window.ArchipelagoMod.shuffleBooks=this.slotData.shuffle_books??0,window.ArchipelagoMod.shuffleEnemies=this.slotData.shuffle_enemies??0,window.ArchipelagoMod.enemyIdsSent=window.ArchipelagoMod.enemyIdsSent??new Set([]),window.ArchipelagoMod.goldMultiplier=this.slotData.gold_multiplier??1,window.ArchipelagoMod.xpMultiplier=this.slotData.xp_multiplier??1,window.ArchipelagoMod.dropMultiplier=this.slotData.drop_multiplier??1,this.sendShopHints=this.slotData.shop_hints??!1,window.ArchipelagoMod.bookHintSpoiler=this.bookHints??{};const d=this.slotData.randomize_book_costs??0;window.ArchipelagoMod.bookCostRandomizer=d,this.isEmpty(this.randomizedBookCosts)&&(this.randomizedBookCosts=this.createRandomizedBookCosts(d)),window.ArchipelagoMod.randomizedBookCosts=this.randomizedBookCosts??{},this.slotData.death_link&&(this.client.deathLink.enableDeathLink(),this.client.updateTags(["AP","DeathLink"])),Item_Inv[this.MOUSE_SLOT]&&(this.connectMouseItem={itemId:Item_Inv[this.MOUSE_SLOT],compo1:Comp1_Inv[this.MOUSE_SLOT],compo2:Comp2_Inv[this.MOUSE_SLOT]},Item_Inv[this.MOUSE_SLOT]=0,Comp1_Inv[this.MOUSE_SLOT]=0,Comp2_Inv[this.MOUSE_SLOT]=0,antiCheatSet(),await this.saveAPData(),this.log("Storing mouse item ("+Item_Catalogue[this.connectMouseItem.itemId][0]+") to be recovered when in-game again.","info")),this.chatLine.style.display="flex",antiCheatSet()}catch(d){Array.isArray(d)&&((a=d[0])==null?void 0:a.target)instanceof WebSocket?this.log("Cannot connect to: "+d[0].target.url+" Please check the hostname and port, or the server's online status.","error"):this.log("Unknown error during connection: "+d,"error"),this._connected=!1,Sequence_Step=0,this.apDiv.style.display="flex",this.connectionBox.style.display="none",this.chatLine.style.display="none"}}getUnlockedClasses(){const e=[];e.push(this.slotData.ranger_class_selected);for(const t of this.receivedItems){const s=this.RANGER_CLASSES[t];s&&e.push(s)}return e}setStagesToWinFromGoal(){const e={0:[88],1:[89],2:[55],3:[88,89],4:[88,55],5:[89,55],6:[88,89,55]},t=this.slotData.goal??0;this.stagesToWin=e[t]||[88]}async sendLocation(e){this._disconnected||!this.client.authenticated||(this.client.check(e),await this.saveAPData())}async _applyItem(e,t){const s=this.RANGER_CLASSES[e];if(s&&(window.ArchipelagoMod.rangerClassesUnlocked.push(s),t&&this.receivedItems.push(e)),e>=this.LOC_OFFSET&&e<this.LOC_OFFSET+999)Stage_Status[e-this.LOC_OFFSET]|=Unlocked,t&&this.receivedItems.push(e),antiCheatSet();else if(e>=this.ITEM_OFFSET&&e<this.ITEM_OFFSET+999&&t){const i=e-this.ITEM_OFFSET,o=this._firstEmptyInvSlot();o>=0?(this.receivedItems.push(e),Item_Inv[o]=i,antiCheatSet()):this.pendingItems.push(e)}await this.saveAPData()}isInPlayableSequenceStep(){return[12,52,53,54,55].includes(Sequence_Step)}async _applyTrap(e){if(console.log("Applying trap: "+e),this.isInPlayableSequenceStep())switch(this.receivedItems.push(e),e){case 13e3:this.unequipItems();break;case 13001:this.loseHalfGold();break;case 13002:this.killRanger();break;case 13003:this.freezeRangers();break;case 13004:this.spawnEnemies();break}else this.pendingTraps.push(e);await this.saveAPData(),antiCheatSet()}unequipItems(){const e=[4,5,6,7].filter(a=>Item_Inv[a]);if(e.length===0)return;const t=a=>{for(let d=a.length-1;d>0;d--){const g=Math.floor(Math.random()*(d+1));[a[d],a[g]]=[a[g],a[d]]}return a},s=(a,d)=>{const g=Item_Inv[a],y=Comp1_Inv[a],p=Comp2_Inv[a];Item_Inv[d]=g,Comp1_Inv[d]=y,Comp2_Inv[d]=p,Item_Inv[a]=0,Comp1_Inv[a]=0,Comp2_Inv[a]=0,antiCheatSet()},i=()=>{if(e.length>0&&Item_Inv[this.MOUSE_SLOT]===0){const a=e.shift();s(a,this.MOUSE_SLOT),MP_Bar[a]=0,Players.PL_gladr_resid_count[a]=0,antiCheatSet()}},o=[];for(let a=this.INV_START;a<Item_Inv.length;a++)a!==this.MOUSE_SLOT&&!Item_Inv[a]&&o.push(a);t(e),t(o),o.length<4&&Item_Inv[this.MOUSE_SLOT]===0&&i();const h=Math.min(o.length,e.length);for(let a=0;a<h;a++){const d=e.shift();s(d,o[a]),MP_Bar[d]=0,Players.PL_gladr_resid_count[d]=0,antiCheatSet()}}loseHalfGold(){const e=Math.floor(Team_Gold/2);Team_Gold-=e,this.log("You lost $"+e+"!","error"),Indicators.INadd(Players.PL_joint[Selected_Player][0].x,Players.PL_joint[Selected_Player][0].y,0,"-$"+e,16727871),antiCheatSet()}killRanger(){const e=[0,1,2,3].filter(s=>LP_Current[s]>0);if(e.length===0)return;const t=e[Math.floor(Math.random()*e.length)];LP_Current[t]=0,antiCheatSet()}freezeRangers(){for(let e=0;e<Stickmen_Slots;e++){const t=Math.floor(Math.random()*750)+1;Players.PL_frozen_ticks[e]=t,antiCheatSet()}}spawnEnemies(){const e=new Set([40,115,163,244,333,334,335,336,337,339]),t=this.randomRangeInt(3,10);for(let s=0;s<t;s++){let i;do i=this.randomRangeInt(1,338);while(e.has(i));const o=Math.floor(Math.random()*((Win_Width>>3)-4-12+1))+12,h=fiftyfifty(Terrain.TR_low_surface[o],Terrain.TR_high_surface[o]);Enemies.ENadd(o,h,i)}}_firstEmptyInvSlot(){for(let e=this.INV_START;e<Item_Inv.length;e++)if(e!==this.MOUSE_SLOT&&!Item_Inv[e])return e;return-1}async _flushPending(){let e;for(;this.pendingItems.length&&(e=this._firstEmptyInvSlot())>=0;){const t=this.pendingItems.shift();console.log("Receiving "+this.pendingItems.length+" items: ",t),this.receivedItems.push(t);const s=t-this.ITEM_OFFSET;Item_Inv[e]=s,antiCheatSet(),await this.saveAPData()}}async scoutBooksOnShopOpen(){if(console.log("Scouting books"),this.slotData.shuffle_books===1){for(let e=0;e<Stage_Status.length;e++)this.excludedBookStages.includes(e)||Stage_Status[e]===3&&!this.bookHints[e]&&this.client.scout([this.BOOK_OFFSET+e],2);await this.saveAPData()}}_tick(){this._disconnected||this._doTickWork().catch(e=>{console.error("Tick error:",e)}),requestAnimationFrame(this._tick)}async _doTickWork(){var e,t,s;if(this._connected&&this.client&&this.client.authenticated){if(Sequence_Step===6&&this.lastSequence===4&&(console.log("New game detected"),this.receivedItems=[],this.slotData.ranger_class_randomizer==1&&(this.unlockForgetTree=!0)),this.unlockForgetTree&&(this.unlockForgetTree=!1,Stage_Status[70]|=Unlocked,antiCheatSet()),Sequence_Step>=6)for(;this._serverItemsQueue.length;){const{index:i,items:o}=this._serverItemsQueue.shift(),h=i===0&&this.receivedItems.length>0;for(const a of o)await this._applyItem(a,!1);if(h){const a=[...o];for(const d of this.receivedItems){const g=a.indexOf(d);g!==-1&&a.splice(g,1)}for(const d of a)d>=this.TRAPS_OFFSET&&d<this.TRAPS_OFFSET+10?await this._applyTrap(d):await this._applyItem(d,!0)}else for(const a of o)a>=this.TRAPS_OFFSET&&a<this.TRAPS_OFFSET+10?await this._applyTrap(a):await this._applyItem(a,!0)}for(let i=0;i<Stage_Status.length;i++)(this.prevStage[i]&Beaten)===0&&(Stage_Status[i]&Beaten)!==0&&(console.log("Sending stage "+i+" as beaten"),await this.sendLocation(i+this.STAGE_COMPLETE_OFFSET)),this.slotData.shuffle_books===1&&(this.prevStage[i]&Booked)===0&&(Stage_Status[i]&Booked)!==0&&(console.log("Sending stage "+i+" as booked"),await this.sendLocation(i+this.BOOK_OFFSET));if(this.prevStage=[...Stage_Status],await this._flushPending(),this.isInPlayableSequenceStep()&&this.pendingTraps.length!==0)for(;this.pendingTraps.length>0;)this._applyTrap(this.pendingTraps.shift());if(!this.winReported&&this.stagesToWin.every(i=>(Stage_Status[i]&Beaten)===Beaten)&&(this.winReported=!0,(e=this.client)==null||e.goal()),this.client.deathLink.enabled&&(Sequence_Step>=11&&Sequence_Step<=13&&this.deathLinkPending&&(this.deathLinkPending=!1,this.die(this.deathLinkSource,this.deathLinkCause)),Sequence_Step===30&&!this.deathLinkSent&&!this.deathLinkReceived&&(this.log("DeathLink: Sending death to your friends..."),this.deathLinkSent=!0,this.client.deathLink.sendDeathLink(this.slotData.player_name,this.slotData.player_name+" was defeated in Stick Ranger.")),Sequence_Step<6&&(this.deathLinkSent=!1,this.deathLinkReceived=!1,this.deathLinkPending=!1)),Sequence_Step===30&&(Item_Inv[this.MOUSE_SLOT]&&(this.deathMouseItem={itemId:Item_Inv[this.MOUSE_SLOT],compo1:Comp1_Inv[this.MOUSE_SLOT],compo2:Comp2_Inv[this.MOUSE_SLOT]},Item_Inv[this.MOUSE_SLOT]=0,Comp1_Inv[this.MOUSE_SLOT]=0,Comp2_Inv[this.MOUSE_SLOT]=0,antiCheatSet(),await this.saveAPData(),this.log("Storing mouse item ("+Item_Catalogue[this.deathMouseItem.itemId][0]+") to be recovered when in-game again.","info")),this.pendingTraps=[]),this.isInPlayableSequenceStep()&&((t=this.deathMouseItem)==null?void 0:t.itemId)>0){const i=this._firstEmptyInvSlot();i!==-1&&(Item_Inv[i]=this.deathMouseItem.itemId,Comp1_Inv[i]=this.deathMouseItem.compo1,Comp2_Inv[i]=this.deathMouseItem.compo2,this.deathMouseItem={},antiCheatSet(),await this.saveAPData(),this.log("Mouse item ("+Item_Catalogue[Item_Inv[i]][0]+") recovered into inventory.","info"))}if(this.isInPlayableSequenceStep()&&((s=this.connectMouseItem)==null?void 0:s.itemId)>0){const i=this._firstEmptyInvSlot();i!==-1&&(Item_Inv[i]=this.connectMouseItem.itemId,Comp1_Inv[i]=this.connectMouseItem.compo1,Comp2_Inv[i]=this.connectMouseItem.compo2,this.connectMouseItem={},antiCheatSet(),await this.saveAPData(),this.log("Mouse item ("+Item_Catalogue[Item_Inv[i]][0]+") recovered into inventory.","info"))}if(this.isInPlayableSequenceStep()&&window.ArchipelagoMod.pendingClassSwapItems.length>0){const i=this._firstEmptyInvSlot();if(i!==-1){const{itemId:o,compo1:h,compo2:a}=window.ArchipelagoMod.pendingClassSwapItems.shift();if([3,4,5,6,58,76,188,289].includes(o)&&h==0&&a==0)return;Item_Inv[i]=o,Comp1_Inv[i]=h,Comp2_Inv[i]=a,antiCheatSet(),await this.saveAPData(),this.log("Equipped item ("+Item_Catalogue[Item_Inv[i]][0]+") recovered into inventory after class swap.","info")}}for(Sequence_Step===54&&!this.isScouting&&this.sendShopHints&&this.slotData.shuffle_books===1&&(this.isScouting=!0,this.scoutBooksOnShopOpen()),Sequence_Step!==54&&this.isScouting&&(this.isScouting=!1);window.ArchipelagoMod.pendingAPItemDrops.length>0;){const i=window.ArchipelagoMod.pendingAPItemDrops.shift();console.log("Sending enemy drop with id: ",i),window.ArchipelagoMod.enemyIdsSent.has(i)||(window.ArchipelagoMod.enemyIdsSent.add(i),await this.sendLocation(i+this.ENEMY_OFFSET))}window.ArchipelagoMod.pendingSave&&(window.ArchipelagoMod.pendingSave=!1,await this.saveAPData())}this.lastSequence=Sequence_Step}randomRangeInt(e,t){return Math.floor(Math.random()*(t-e+1))+e}}window.ap=new kt;
