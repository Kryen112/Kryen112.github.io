var Xe=Object.defineProperty;var He=a=>{throw TypeError(a)};var et=(a,e,t)=>e in a?Xe(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var u=(a,e,t)=>et(a,typeof e!="symbol"?e+"":e,t),Be=(a,e,t)=>e.has(a)||He("Cannot "+t);var n=(a,e,t)=>(Be(a,e,"read from private field"),t?t.call(a):e.get(a)),h=(a,e,t)=>e.has(a)?He("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(a):e.set(a,t),r=(a,e,t,s)=>(Be(a,e,"write to private field"),s?s.call(a,t):e.set(a,t),t),U=(a,e,t)=>(Be(a,e,"access private method"),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const c of o.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&s(c)}).observe(document,{childList:!0,subtree:!0});function t(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(i){if(i.ep)return;i.ep=!0;const o=t(i);fetch(i.href,o)}})();var tt=Object.defineProperty,st=(a,e)=>{for(var t in e)tt(a,t,{get:e[t],enumerable:!0,configurable:!0,set:s=>e[t]=()=>s})},it={};st(it,{slotTypes:()=>Ee,permissions:()=>nt,itemsHandlingFlags:()=>Ue,itemClassifications:()=>x,clientStatuses:()=>Ne});var Ne={disconnected:0,connected:5,ready:10,playing:20,goal:30},x={progression:1,useful:2,trap:4,none:0},Ue={minimal:0,others:1,own:2,starting:4,all:7},nt={disabled:0,enabled:1,goal:2,auto:6,autoEnabled:7},Ee={spectator:0,player:1,group:2};class J extends Error{}class ot extends Error{constructor(t,s,i){super(t);u(this,"argumentName");u(this,"value");this.argumentName=s,this.value=structuredClone(i)}}class at extends Error{constructor(t,s){super(t);u(this,"errors",[]);this.errors=s}}class A extends Error{}var je={timeout:1e4,autoFetchDataPackage:!0,maximumMessages:1e3,debugLogVersions:!0},rt={major:0,minor:5,build:1},ht="2.0.4";function qe(){const a=[];for(let e=0;e<36;e++)a.push(Math.floor(Math.random()*16));return a[14]=4,a[19]=a[19]&=-5,a[19]=a[19]|=8,a[8]=a[13]=a[18]=a[23]="-",a.map(e=>e.toString(16)).join("")}var De={password:"",uuid:qe(),tags:[],version:rt,items:Ue.all,slotData:!0},Z,L,le,de;class Y{constructor(e,t,s,i){h(this,Z);h(this,L);h(this,le);h(this,de);r(this,Z,e),r(this,L,t),r(this,le,s),r(this,de,i)}toString(){return this.name}get receiver(){return n(this,de)}get sender(){return n(this,le)}get name(){return n(this,Z).package.lookupItemName(this.game,n(this,L).item,!0)}get id(){return n(this,L).item}get locationName(){return n(this,Z).package.lookupLocationName(this.sender.game,n(this,L).location,!0)}get locationId(){return n(this,L).location}get locationGame(){return this.sender.game}get game(){return this.receiver.game}get progression(){return(this.flags&x.progression)===x.progression}get useful(){return(this.flags&x.useful)===x.useful}get trap(){return(this.flags&x.trap)===x.trap}get filler(){return this.flags===x.none}get flags(){return n(this,L).flags}}Z=new WeakMap,L=new WeakMap,le=new WeakMap,de=new WeakMap;class $e{constructor(e,t){u(this,"game");u(this,"checksum");u(this,"itemTable");u(this,"locationTable");u(this,"reverseItemTable");u(this,"reverseLocationTable");this.game=e,this.checksum=t.checksum,this.itemTable=Object.freeze(t.item_name_to_id),this.locationTable=Object.freeze(t.location_name_to_id),this.reverseItemTable=Object.freeze(Object.fromEntries(Object.entries(this.itemTable).map(([s,i])=>[i,s]))),this.reverseLocationTable=Object.freeze(Object.fromEntries(Object.entries(this.locationTable).map(([s,i])=>[i,s])))}exportPackage(){return{checksum:this.checksum,item_name_to_id:{...this.itemTable},location_name_to_id:{...this.locationTable}}}}var Q,P,q,z,Te,Ge;class ct{constructor(e){h(this,Te);h(this,Q);h(this,P,new Map);h(this,q,new Map);h(this,z,new Set);r(this,Q,e),n(this,Q).socket.on("roomInfo",t=>{n(this,P).clear(),n(this,q).clear(),n(this,z).clear(),n(this,P).set("Archipelago",U(this,Te,Ge).call(this));for(const s in t.datapackage_checksums)n(this,q).set(s,t.datapackage_checksums[s]),n(this,z).add(s)})}findPackage(e){return n(this,P).get(e)??null}async fetchPackage(e=[],t=!0){e.length===0&&(e=Array.from(n(this,z))),e=e.filter(i=>{var o;return n(this,z).has(i)?((o=n(this,P).get(i))==null?void 0:o.checksum)!==n(this,q).get(i):!1});const s={games:{}};for(const i of e){const o={cmd:"GetDataPackage",games:[i]},[c]=await n(this,Q).socket.send(o).wait("dataPackage");s.games[i]=c.data.games[i]}return t&&this.importPackage(s),s}importPackage(e){for(const t in e.games)n(this,P).set(t,new $e(t,e.games[t])),n(this,q).set(t,e.games[t].checksum)}exportPackage(){return{games:n(this,P).entries().reduce((e,[t,s])=>(e[t]=s.exportPackage(),e),{})}}lookupItemName(e,t,s=!0){const i=`Unknown Item ${t}`,o=this.findPackage(e);if(!o)return s?i:void 0;const c=o.reverseItemTable[t];return s&&c===void 0?i:c}lookupLocationName(e,t,s=!0){const i=`Unknown Location ${t}`,o=this.findPackage(e);if(!o)return s?i:void 0;const c=o.reverseLocationTable[t];return s&&c===void 0?i:c}}Q=new WeakMap,P=new WeakMap,q=new WeakMap,z=new WeakMap,Te=new WeakSet,Ge=function(){return new $e("Archipelago",{checksum:"ac9141e9ad0318df2fa27da5f20c50a842afeecb",item_name_to_id:{Nothing:-1},location_name_to_id:{"Cheat Console":-1,Server:-2}})};var X,_,ue,me;class lt{constructor(e,t,s){h(this,X);h(this,_,[]);h(this,ue);h(this,me);r(this,X,e),r(this,ue,t),r(this,me,s)}replace(e){return n(this,_).push({operation:"replace",value:e}),this}default(){return n(this,_).push({operation:"default",value:null}),this}add(e){return n(this,_).push({operation:"add",value:e}),this}multiply(e){return n(this,_).push({operation:"mul",value:e}),this}power(e){return n(this,_).push({operation:"pow",value:e}),this}remainder(e){return n(this,_).push({operation:"mod",value:e}),this}floor(){return n(this,_).push({operation:"floor",value:null}),this}ceiling(){return n(this,_).push({operation:"ceil",value:null}),this}max(e){return n(this,_).push({operation:"max",value:e}),this}min(e){return n(this,_).push({operation:"min",value:e}),this}and(e){return n(this,_).push({operation:"and",value:e}),this}or(e){return n(this,_).push({operation:"or",value:e}),this}xor(e){return n(this,_).push({operation:"xor",value:e}),this}leftShift(e){return n(this,_).push({operation:"left_shift",value:e}),this}rightShift(e){return n(this,_).push({operation:"right_shift",value:e}),this}remove(e){return n(this,_).push({operation:"remove",value:e}),this}pop(e){return n(this,_).push({operation:"pop",value:e}),this}update(e){return n(this,_).push({operation:"update",value:e}),this}async commit(e=!1){const t=qe(),s={cmd:"Set",default:n(this,me),key:n(this,ue),operations:n(this,_),want_reply:e,uuid:t};if(n(this,X).socket.send(s),!e)return;const[i]=await n(this,X).socket.wait("setReply",o=>o.uuid===t);return i.value}}X=new WeakMap,_=new WeakMap,ue=new WeakMap,me=new WeakMap;var C,M,H,Oe,Ke;class dt{constructor(e){h(this,Oe);h(this,C);h(this,M,{});h(this,H,{});r(this,C,e),n(this,C).socket.on("disconnected",()=>{r(this,M,{}),r(this,H,{})}).on("setReply",t=>{n(this,M)[t.key]=t.value;const s=n(this,H)[t.key];s&&s.forEach(i=>i(t.key,t.value,t.original_value))}).on("connected",()=>{if(n(this,C).options.debugLogVersions){const t=`${n(this,C).game}:${ht}:${navigator==null?void 0:navigator.userAgent}`;this.prepare("archipelago.js__runtimes",{}).default().update({[t]:!0}).commit(!1)}})}get store(){return structuredClone(n(this,M))}async fetch(e,t=!1){let s=typeof e=="string"?[e]:e;if(t){const o=s.filter(c=>n(this,M)[c]===void 0);o.length>0&&n(this,C).socket.send({cmd:"SetNotify",keys:o})}let i={};if(s=s.filter(o=>{const c=structuredClone(n(this,M)[o]),l=c!==void 0;return l&&(i[o]=c),!l}),s.length>0){const o=await U(this,Oe,Ke).call(this,s);i={...i,...o}}return t&&r(this,M,{...n(this,M),...i}),typeof e=="string"?i[e]:i}async notify(e,t){return e.forEach(s=>{var i;(i=n(this,H))[s]??(i[s]=[]),n(this,H)[s].push(t)}),this.fetch(e,!0)}prepare(e,t){if(e.startsWith("_read_"))throw TypeError("Cannot manipulate read only keys.");return new lt(n(this,C),e,t)}async fetchItemNameGroups(e){return await this.fetch([`_read_item_name_groups_${e}`],!0)}async fetchLocationNameGroups(e){return await this.fetch([`_read_location_name_groups_${e}`],!0)}}C=new WeakMap,M=new WeakMap,H=new WeakMap,Oe=new WeakSet,Ke=async function(e){const t=qe(),[s]=await n(this,C).socket.send({cmd:"Get",keys:e,uuid:t}).wait("retrieved",i=>i.uuid===t);return s.keys};var R;class ut{constructor(){h(this,R,{})}addEventListener(e,t,s=!1){var i;(i=n(this,R))[e]??(i[e]=[]),n(this,R)[e].push([t,s])}removeEventListener(e,t){const s=n(this,R)[e];s&&s.length>0&&(n(this,R)[e]=s.filter(([i])=>i!==t))}dispatchEvent(e,t){const s=n(this,R)[e]??[];for(const[i,o]of s)i(...t),o&&this.removeEventListener(e,i)}}R=new WeakMap;var F;class ce{constructor(){h(this,F,new ut)}on(e,t){return n(this,F).addEventListener(e,t),this}off(e,t){return n(this,F).removeEventListener(e,t),this}async wait(e,t=()=>!0){return new Promise(s=>{const i=(...o)=>{t(...o)&&(n(this,F).removeEventListener(e,i),s(o))};n(this,F).addEventListener(e,i)})}emit(e,t){n(this,F).dispatchEvent(e,t)}}F=new WeakMap;var I,j;class mt extends ce{constructor(t){super();h(this,I);h(this,j,Number.MIN_SAFE_INTEGER);r(this,I,t),n(this,I).socket.on("bounced",s=>{var i;if((i=s.tags)!=null&&i.includes("DeathLink")&&s.data.time&&s.data.source){const o=s.data;if(o.time===n(this,j))return;r(this,j,o.time),this.emit("deathReceived",[o.source,o.time*1e3,o.cause])}})}get enabled(){return n(this,I).arguments.tags.includes("DeathLink")}enableDeathLink(){n(this,I).arguments.tags.includes("DeathLink")||n(this,I).updateTags([...n(this,I).arguments.tags,"DeathLink"])}disableDeathLink(){n(this,I).arguments.tags.includes("DeathLink")&&n(this,I).updateTags(n(this,I).arguments.tags.filter(t=>t!=="DeathLink"))}sendDeathLink(t,s){if(!n(this,I).authenticated)throw new A("Cannot send death links before connecting and authenticating.");if(!this.enabled)return;r(this,j,Math.ceil(Date.now()/1e3));const i={source:t,cause:s,time:n(this,j)};n(this,I).bounce({tags:["DeathLink"]},i)}}I=new WeakMap,j=new WeakMap;var $,ee,ge;class Le{constructor(e,t){h(this,$);h(this,ee);h(this,ge);r(this,$,e),r(this,ee,t),r(this,ge,new Y(n(this,$),{item:t.item,location:t.location,player:t.finding_player,flags:t.item_flags},n(this,$).players.findPlayer(t.finding_player),n(this,$).players.findPlayer(t.receiving_player)))}get item(){return n(this,ge)}get found(){return n(this,ee).found}get entrance(){return n(this,ee).entrance||"Vanilla"}}$=new WeakMap,ee=new WeakMap,ge=new WeakMap;var S,B,k,xe,Ve;class gt extends ce{constructor(t){super();h(this,xe);h(this,S);h(this,B,[]);h(this,k,[]);r(this,S,t),n(this,S).socket.on("receivedItems",s=>{let i=s.index;const o=s.items.length,c=[...s.items];for(;c.length>0;){const l=c.shift();n(this,B)[i++]=new Y(n(this,S),l,n(this,S).players.findPlayer(l.player),n(this,S).players.self)}this.emit("itemsReceived",[n(this,B).slice(s.index,s.index+o),s.index])}).on("connected",()=>{r(this,k,[]),r(this,B,[]),n(this,S).storage.notify([`_read_hints_${n(this,S).players.self.team}_${n(this,S).players.self.slot}`],U(this,xe,Ve).bind(this)).then(s=>{const i=s[`_read_hints_${n(this,S).players.self.team}_${n(this,S).players.self.slot}`];r(this,k,i.map(o=>new Le(n(this,S),o))),this.emit("hintsInitialized",[n(this,k)])}).catch(s=>{throw s})})}get received(){return[...n(this,B)]}get hints(){return[...n(this,k)]}get count(){return n(this,B).length}}S=new WeakMap,B=new WeakMap,k=new WeakMap,xe=new WeakSet,Ve=function(t,s){for(let i=0;i<s.length;i++)n(this,k)[i]===void 0?(n(this,k)[i]=new Le(n(this,S),s[i]),this.emit("hintReceived",[n(this,k)[i]])):n(this,k)[i].found!==s[i].found&&(n(this,k)[i]=new Le(n(this,S),s[i]),this.emit("hintFound",[n(this,k)[i]]))};class Ce{constructor(e,t){u(this,"client");u(this,"part");this.client=e,this.part=t}toString(){return this.text}}class pt extends Ce{constructor(t,s,i,o){super(t,s);u(this,"part");u(this,"type","item");u(this,"item");const c=t.players.findPlayer(s.player,o.team);this.part=s,this.item=new Y(t,i,c,o)}get text(){return this.item.name}}var te;class ft extends Ce{constructor(t,s){super(t,s);h(this,te);u(this,"part");u(this,"type","location");u(this,"id");const i=t.players.findPlayer(s.player),o=t.package.findPackage(i.game);this.part=s,s.type==="location_name"?(r(this,te,s.text),this.id=o.locationTable[s.text]):(this.id=parseInt(s.text),r(this,te,t.package.lookupLocationName(i.game,this.id,!0)))}get text(){return n(this,te)}}te=new WeakMap;class _t extends Ce{constructor(t,s){super(t,s);u(this,"part");u(this,"type","color");u(this,"color");this.part=s,this.color=s.color}get text(){return this.part.text}}class yt extends Ce{constructor(t,s){super(t,s);u(this,"part");u(this,"type");this.part=s,this.part.type==="entrance_name"?this.type="entrance":this.type="text"}get text(){return this.part.text}}class St extends Ce{constructor(t,s){super(t,s);u(this,"part");u(this,"type","player");u(this,"player");if(this.part=s,s.type==="player_id")this.player=t.players.findPlayer(parseInt(s.text));else{const i=t.players.teams[t.players.self.team].find(o=>o.name===s.text);if(!i)throw new Error(`Cannot find player under name: ${s.text}`);this.player=i}}get text(){return this.player.alias}}var g,Ae,Re,Ye;class wt extends ce{constructor(t){super();h(this,Re);h(this,g);h(this,Ae,[]);r(this,g,t),n(this,g).socket.on("printJSON",U(this,Re,Ye).bind(this))}get log(){return[...n(this,Ae)]}async say(t){if(!n(this,g).authenticated)throw new A("Cannot send chat messages without being authenticated.");t=t.trim();const s={cmd:"Say",text:t};n(this,g).socket.send(s),await this.wait("chat",i=>i===t)}}g=new WeakMap,Ae=new WeakMap,Re=new WeakSet,Ye=function(t){const s=[];for(const o of t.data)switch(o.type){case"item_id":case"item_name":{const c=t;let l;c.type==="ItemCheat"?l=n(this,g).players.findPlayer(c.receiving,c.team):l=n(this,g).players.findPlayer(c.receiving),s.push(new pt(n(this,g),o,c.item,l));break}case"location_id":case"location_name":{s.push(new ft(n(this,g),o));break}case"color":{s.push(new _t(n(this,g),o));break}case"player_id":case"player_name":{s.push(new St(n(this,g),o));break}default:{s.push(new yt(n(this,g),o));break}}const i=s.map(o=>o.text).join();switch(n(this,g).options.maximumMessages>=1&&(this.log.push({text:i,nodes:s}),this.log.splice(0,this.log.length-n(this,g).options.maximumMessages)),t.type){case"ItemSend":{const o=n(this,g).players.findPlayer(t.item.player),c=n(this,g).players.findPlayer(t.receiving),l=new Y(n(this,g),t.item,o,c);this.emit("itemSent",[i,l,s]);break}case"ItemCheat":{const o=n(this,g).players.findPlayer(t.item.player,t.team),c=n(this,g).players.findPlayer(t.receiving,t.team),l=new Y(n(this,g),t.item,o,c);this.emit("itemCheated",[i,l,s]);break}case"Hint":{const o=n(this,g).players.findPlayer(t.item.player),c=n(this,g).players.findPlayer(t.receiving),l=new Y(n(this,g),t.item,o,c);this.emit("itemHinted",[i,l,t.found,s]);break}case"Join":{const o=n(this,g).players.findPlayer(t.slot,t.team);this.emit("connected",[i,o,t.tags,s]);break}case"Part":{const o=n(this,g).players.findPlayer(t.slot,t.team);this.emit("disconnected",[i,o,s]);break}case"Chat":{const o=n(this,g).players.findPlayer(t.slot,t.team);this.emit("chat",[t.message,o,s]);break}case"ServerChat":{this.emit("serverChat",[t.message,s]);break}case"TagsChanged":{const o=n(this,g).players.findPlayer(t.slot,t.team);this.emit("tagsUpdated",[i,o,t.tags,s]);break}case"Tutorial":{this.emit("tutorial",[i,s]);break}case"CommandResult":{this.emit("userCommand",[i,s]);break}case"AdminCommandResult":{this.emit("adminCommand",[i,s]);break}case"Goal":{const o=n(this,g).players.findPlayer(t.slot,t.team);this.emit("goaled",[i,o,s]);break}case"Release":{const o=n(this,g).players.findPlayer(t.slot,t.team);this.emit("released",[i,o,s]);break}case"Collect":{const o=n(this,g).players.findPlayer(t.slot,t.team);this.emit("collected",[i,o,s]);break}case"Countdown":this.emit("countdown",[i,t.countdown,s])}this.emit("message",[i,s])};var b,D,se,Pe;class Me{constructor(e,t){h(this,se);h(this,b);h(this,D);r(this,b,e),r(this,D,t)}toString(){return this.alias}get name(){return n(this,D).name}get alias(){return n(this,D).alias}get game(){return this.slot===0?"Archipelago":n(this,se,Pe).game}get type(){return this.slot===0?Ee.spectator:n(this,se,Pe).type}get team(){return n(this,D).team}get slot(){return n(this,D).slot}get members(){return this.type!==Ee.group?[]:n(this,b).players.teams[this.team].filter(e=>n(this,se,Pe).group_members.includes(e.slot))}get groups(){return this.slot===0?[]:n(this,b).players.teams[this.team].filter(e=>e.slot!==0&&n(this,b).players.slots[e.slot].group_members.includes(this.slot))}async fetchStatus(){return this.type===Ee.group?Ne.goal:await n(this,b).storage.fetch(`_read_client_status_${this.team}_${this.slot}`)??0}async fetchSlotData(){return await n(this,b).storage.fetch(`_read_slot_data_${this.slot}`)}async fetchHints(){return(await n(this,b).storage.fetch(`_read_hints_${this.team}_${this.slot}`)).map(t=>new Le(n(this,b),t))}}b=new WeakMap,D=new WeakMap,se=new WeakSet,Pe=function(){return n(this,b).players.slots[this.slot]};var E,v,pe,ie,fe;class vt extends ce{constructor(t){super();h(this,E);h(this,v,[]);h(this,pe,{});h(this,ie,0);h(this,fe,0);r(this,E,t),n(this,E).socket.on("connected",s=>{var i,o;r(this,pe,Object.freeze(s.slot_info)),r(this,v,[]),r(this,ie,s.slot),r(this,fe,s.team);for(const c of s.players)(i=n(this,v))[o=c.team]??(i[o]=[{team:c.team,slot:0,name:"Archipelago",alias:"Archipelago"}]),n(this,v)[c.team][c.slot]=c}).on("roomUpdate",s=>{if(s.players){for(const i of s.players)if(n(this,v)[i.team][i.slot].alias!==i.alias){const o=n(this,v)[i.team][i.slot].alias;n(this,v)[i.team][i.slot]=i,this.emit("aliasUpdated",[new Me(n(this,E),i),o,i.alias])}}})}get self(){if(n(this,ie)===0)throw new Error("Cannot lookup own player object when client has never connected to a server.");return new Me(n(this,E),n(this,v)[n(this,fe)][n(this,ie)])}get slots(){return n(this,pe)}get teams(){const t=[];for(let s=0;s<n(this,v).length;s++){t[s]=[];for(let i=0;i<n(this,v)[s].length;i++)t[s].push(new Me(n(this,E),n(this,v)[s][i]))}return t}findPlayer(t,s){if(s===void 0&&(s=n(this,E).players.self.team),n(this,v)[s])return new Me(n(this,E),n(this,v)[s][t])}}E=new WeakMap,v=new WeakMap,pe=new WeakMap,ie=new WeakMap,fe=new WeakMap;var _e,ye,Se,we,ve,Ie,ne,W,oe,G,K,V,N,Fe;class It extends ce{constructor(t){super();h(this,_e);h(this,ye,{major:-1,minor:-1,build:-1});h(this,Se,{major:-1,minor:-1,build:-1});h(this,we,[]);h(this,ve,[]);h(this,Ie,"");h(this,ne,!1);h(this,W,0);h(this,oe,0);h(this,G,0);h(this,K,{release:0,collect:0,remaining:0});h(this,V,[]);h(this,N,[]);h(this,Fe,!1);r(this,_e,t),n(this,_e).socket.on("roomInfo",s=>{r(this,ye,{major:s.version.major,minor:s.version.minor,build:s.version.build}),r(this,Se,{major:s.generator_version.major,minor:s.generator_version.minor,build:s.generator_version.build}),r(this,ve,s.tags),r(this,we,s.games),r(this,Ie,s.seed_name),r(this,ne,s.password),r(this,K,s.permissions),r(this,oe,s.hint_cost),r(this,G,s.location_check_points)}).on("connected",s=>{r(this,V,s.missing_locations),r(this,N,s.checked_locations),this.emit("locationsChecked",[this.checkedLocations]),r(this,W,s.hint_points),this.emit("hintPointsUpdated",[0,s.hint_points])}).on("roomUpdate",s=>{if(s.hint_cost!==void 0){const[i,o]=[this.hintCost,this.hintCostPercentage];r(this,oe,s.hint_cost),this.emit("hintCostUpdated",[i,this.hintCost,o,this.hintCostPercentage])}if(s.hint_points!==void 0){const i=n(this,W);r(this,W,s.hint_points),this.emit("hintPointsUpdated",[i,this.hintPoints])}if(s.location_check_points!==void 0){const i=n(this,G);r(this,G,s.location_check_points),this.emit("locationCheckPointsUpdated",[i,this.locationCheckPoints])}if(s.password!==void 0&&(r(this,ne,s.password),this.emit("passwordUpdated",[this.password])),s.permissions!==void 0){const i=n(this,K);r(this,K,s.permissions),this.emit("permissionsUpdated",[i,this.permissions])}s.checked_locations!==void 0&&(r(this,N,[...n(this,N),...s.checked_locations]),r(this,V,this.missingLocations.filter(i=>{var o;return!((o=s.checked_locations)!=null&&o.includes(i))})),this.emit("locationsChecked",[s.checked_locations]))})}get serverVersion(){return{...n(this,ye)}}get generatorVersion(){return{...n(this,Se)}}get games(){return[...n(this,we)]}get tags(){return[...n(this,ve)]}get seedName(){return n(this,Ie)}get password(){return n(this,ne)}get permissions(){return{...n(this,K)}}get hintPoints(){return n(this,W)}get hintCost(){return this.hintCostPercentage>0?Math.max(1,Math.floor(this.hintCostPercentage*this.allLocations.length*.01)):0}get hintCostPercentage(){return n(this,oe)}get locationCheckPoints(){return n(this,G)}get missingLocations(){return[...n(this,V)].sort()}get checkedLocations(){return[...n(this,N)].sort()}get allLocations(){return[...n(this,V),...n(this,N)].sort()}get race(){return n(this,Fe)}}_e=new WeakMap,ye=new WeakMap,Se=new WeakMap,we=new WeakMap,ve=new WeakMap,Ie=new WeakMap,ne=new WeakMap,W=new WeakMap,oe=new WeakMap,G=new WeakMap,K=new WeakMap,V=new WeakMap,N=new WeakMap,Fe=new WeakMap;var w,ae,he,Je,Ze;class kt extends ce{constructor(){super();h(this,he);h(this,w,null);h(this,ae,!1)}get connected(){return n(this,ae)}get url(){var t;return((t=n(this,w))==null?void 0:t.url)??""}send(...t){if(n(this,w))return n(this,w).send(JSON.stringify(t)),this.emit("sentPackets",[t]),this;throw new J("Unable to send packets to the server; not connected to a server.")}async connect(t){if(this.disconnect(),typeof t=="string"){if(!/^([a-zA-Z]+:)\/\/[A-Za-z0-9_.~\-:]+/i.test(t))try{return await this.connect(new URL(`wss://${t}`))}catch{return await this.connect(new URL(`ws://${t}`))}t=new URL(t)}if(t.port=t.port||"38281",t.protocol!=="wss:"&&t.protocol!=="ws:")throw new TypeError("Unexpected protocol. Archipelago only supports the ws:// and wss:// protocols.");try{return new Promise((s,i)=>{const o=U(this,he,Ze).call(this);if(o===null)throw new J("Unable to find a suitable WebSocket API in the current runtime.");r(this,w,new o(t)),n(this,w).onmessage=U(this,he,Je).bind(this),n(this,w).onclose=()=>{this.disconnect(),i(new J("Failed to connect to Archipelago server."))},n(this,w).onerror=()=>{this.disconnect(),i(new J("Failed to connect to Archipelago server."))},n(this,w).onopen=()=>{this.wait("roomInfo").then(([c])=>{if(r(this,ae,!0),n(this,w)){n(this,w).onclose=this.disconnect.bind(this),n(this,w).onerror=this.disconnect.bind(this),s(c);return}this.disconnect(),i(new J("Failed to connect to Archipelago server."))}).catch(c=>{throw c})}})}catch(s){throw this.disconnect(),s}}disconnect(){var t;this.connected&&(r(this,ae,!1),(t=n(this,w))==null||t.close(),r(this,w,null),this.emit("disconnected",[]))}}w=new WeakMap,ae=new WeakMap,he=new WeakSet,Je=function(t){const s=JSON.parse(t.data);for(const i of s){switch(i.cmd){case"ConnectionRefused":this.emit("connectionRefused",[i]);break;case"Bounced":this.emit("bounced",[i,i.data]);break;case"Connected":this.emit("connected",[i]);break;case"DataPackage":this.emit("dataPackage",[i]);break;case"InvalidPacket":this.emit("invalidPacket",[i]);break;case"LocationInfo":this.emit("locationInfo",[i]);break;case"PrintJSON":this.emit("printJSON",[i]);break;case"ReceivedItems":this.emit("receivedItems",[i]);break;case"Retrieved":this.emit("retrieved",[i]);break;case"RoomInfo":this.emit("roomInfo",[i]);break;case"RoomUpdate":this.emit("roomUpdate",[i]);break;case"SetReply":this.emit("setReply",[i]);break}this.emit("receivedPacket",[i])}},Ze=function(){let t=null;return typeof window<"u"?t=window.WebSocket||window.MozWebSocket:typeof global<"u"?t=global.WebSocket||global.MozWebSocket:typeof self<"u"?t=self.WebSocket||self.MozWebSocket:typeof WebSocket<"u"?t=WebSocket:typeof MozWebSocket<"u"&&(t=MozWebSocket),t};var re,T,ke,be;class bt{constructor(e){h(this,re,!1);h(this,T,De);h(this,ke,"");h(this,be,"");u(this,"socket",new kt);u(this,"package",new ct(this));u(this,"storage",new dt(this));u(this,"room",new It(this));u(this,"players",new vt(this));u(this,"items",new gt(this));u(this,"messages",new wt(this));u(this,"deathLink",new mt(this));u(this,"options");e?this.options={...je,...e}:this.options={...je},this.socket.on("disconnected",()=>{r(this,re,!1)}).on("sentPackets",t=>{for(const s of t)s.cmd==="ConnectUpdate"&&(n(this,T).tags=s.tags,n(this,T).items=s.items_handling)})}get authenticated(){return this.socket.connected&&n(this,re)}get name(){return n(this,ke)}get game(){return n(this,be)}get arguments(){return{...n(this,T)}}async login(e,t,s="",i){if(t==="")throw new ot("Provided slot name cannot be blank.","name",t);i?r(this,T,{...De,...i}):r(this,T,{...De});const o=new Set(this.arguments.tags);!s&&!o.has("HintGame")&&!o.has("Tracker")&&!o.has("TextOnly")&&o.add("TextOnly"),n(this,T).tags=Array.from(o);const c={cmd:"Connect",name:t,game:s,password:this.arguments.password,slot_data:this.arguments.slotData,items_handling:this.arguments.items,uuid:this.arguments.uuid,tags:this.arguments.tags,version:{...this.arguments.version,class:"Version"}};return await this.socket.connect(e),this.options.autoFetchDataPackage&&await this.package.fetchPackage(),new Promise((l,d)=>{const m=setTimeout(()=>d(new J("Server failed to respond in time.")),this.options.timeout),y=f=>{r(this,re,!0),r(this,be,f.slot_info[f.slot].game),r(this,ke,f.slot_info[f.slot].name),this.socket.off("connected",y).off("connectionRefused",p),clearTimeout(m),l(f.slot_data)},p=f=>{var O;this.socket.off("connected",y).off("connectionRefused",p),clearTimeout(m),d(new at(`Connection was refused by the server. Reason(s): [${(O=f.errors)==null?void 0:O.join(", ")}`,f.errors??[]))};this.socket.on("connected",y.bind(this)).on("connectionRefused",p.bind(this)).send(c)})}updateStatus(e){if(!this.authenticated)throw new A("Cannot update status while not connected and authenticated.");this.socket.send({cmd:"StatusUpdate",status:e})}goal(){this.updateStatus(Ne.goal)}updateTags(e){if(!this.authenticated)throw new A("Cannot update tags while not connected and authenticated.");this.socket.send({cmd:"ConnectUpdate",tags:e,items_handling:this.arguments.items})}updateItemsHandling(e){if(!this.authenticated)throw new A("Cannot update tags while not connected and authenticated.");this.socket.send({cmd:"ConnectUpdate",tags:this.arguments.tags,items_handling:e})}check(...e){if(!this.authenticated)throw new A("Cannot check locations while not connected and authenticated.");e=e.filter(t=>this.room.missingLocations.includes(t)),this.socket.send({cmd:"LocationChecks",locations:e})}async scout(e,t=0){if(!this.authenticated)throw new A("Cannot scout locations while not connected and authenticated.");e=e.filter(i=>this.room.allLocations.includes(i));const[s]=await this.socket.send({cmd:"LocationScouts",create_as_hint:t,locations:e}).wait("locationInfo",i=>i.locations.map(o=>o.location).toSorted().join(",")===e.toSorted().join(","));return s.locations.map(i=>new Y(this,i,this.players.self,this.players.findPlayer(i.player)))}bounce(e,t){if(!this.authenticated)throw new A("Cannot send bounces while not connected and authenticated.");this.socket.send({cmd:"Bounce",data:t,games:e.games??[],slots:e.slots??[],tags:e.tags??[]})}}re=new WeakMap,T=new WeakMap,ke=new WeakMap,be=new WeakMap;function Qe(){return new Promise((a,e)=>{const t=indexedDB.open("StickRangerAP",1);t.onupgradeneeded=()=>t.result.createObjectStore("savegames"),t.onsuccess=()=>a(t.result),t.onerror=()=>e(t.error)})}async function We(a){const e=await Qe();return new Promise((t,s)=>{const o=e.transaction("savegames","readonly").objectStore("savegames").get(a);o.onsuccess=()=>t(o.result),o.onerror=()=>s(o.error)})}async function Ct(a,e){const t=await Qe();return new Promise((s,i)=>{const o=t.transaction("savegames","readwrite");o.objectStore("savegames").put(e,a),o.oncomplete=()=>s(),o.onerror=()=>i(o.error)})}class Mt{constructor(){this.STAGE_COMPLETE_OFFSET=1e4,this.BOOK_OFFSET=10100,this.ENEMY_OFFSET=10200,this.LOC_OFFSET=11e3,this.ITEM_OFFSET=12e3,this.TRAPS_OFFSET=13e3,this.INV_START=16,this.MOUSE_SLOT=40,this.STAGE_TO_WIN=88,this._pendingConnect=!1,this._connected=!1,this._disconnected=!1,this.receivedItems=[],this.pendingItems=[],this.prevStage=[...Stage_Status],this.winReported=!1,this.lastSequence=-1,this.storageKey="",this.sendShopHints=!1,this.isScouting=!1,this.excludedBookStages=[0,20,47,70,77],this.bookHints={},this.randomizedBookCosts={},this.slotData={},this.deathLinkSent=!1,this.deathLinkReceived=!1,this.deathLinkPending=!1,this.deathLinkSource="",this.deathLinkTime="",this.deathLinkCause="",this.newGame=!1,this.pendingTraps=[],this.deathMouseItem={},this.connectMouseItem={},this.host=document.getElementById("host"),this.port=document.getElementById("port"),this.slotName=document.getElementById("slotName"),this.password=document.getElementById("password"),this.connect=document.getElementById("connect"),this.connectionBox=document.getElementById("connectionBox"),this.connectionInfo=document.getElementById("connectionInfo"),this.disconnect=document.getElementById("disconnect"),this.chatLine=document.getElementById("chatLine"),this.message=document.getElementById("message"),this.send=document.getElementById("send"),this.chatMessages=document.getElementById("chatMessages"),this.apDiv=document.getElementById("APConnection"),this.connect.addEventListener("click",()=>this._onConnectClick());const e=t=>{t.addEventListener("keydown",s=>{s.key==="Enter"&&this._onConnectClick()})};e(this.host),e(this.port),e(this.slotName),e(this.password),this.disconnect.addEventListener("click",()=>{var t;return(t=this.client)==null?void 0:t.socket.disconnect()}),this.send.addEventListener("click",()=>this._onSendClick()),this.message.addEventListener("keydown",t=>{t.key==="Enter"&&this._onSendClick()}),window.addEventListener("beforeunload",()=>this._onUnload()),this._tick=this._tick.bind(this),requestAnimationFrame(this._tick)}async _onConnectClick(){if(this.connectionInfo.textContent="Connected at: "+this.host.value+":"+this.port.value+" - "+this.slotName.value,!this._disconnected){this.storageKey=[this.host.value,this.port.value,"Stick Ranger",this.slotName.value].join(":");const e=await We(this.storageKey);e&&(this.receivedItems=e.receivedItems,this.bookHints=e.bookHints??{},this.randomizedBookCosts=e.randomizedBookCosts??{},this.deathMouseItem=e.deathMouseItem??{},this.connectMouseItem=e.connectMouseItem??{},window.ArchipelagoMod.enemyIdsSent=new Set(e.enemyIdsSent??[]),GameLoad(e.save.replace(/\r\n|\r|\n/g,"")))}this._disconnected=!1,this._pendingConnect=!0,this.apDiv.style.display="none",this.connectionBox.style.display="flex",this.log("Waiting for the game to enter the map...","info")}async _onDisconnect(){this._connected=!1,this._disconnected=!0,this._pendingConnect=!1,await this.saveState(),this.apDiv.style.display="flex",this.connectionBox.style.display="none",this.chatLine.style.display="none",this.log("Disconnected from multiworld server.","info")}_onSendClick(){const e=this.message.value.trim();e.length!==0&&(this.client.messages.say(e),e[0]==="/"&&this.log("Cannot issue command "+e.slice(1).split(" ")[0]+". Client commands are not yet supported."),this.message.value="")}log(e,t="info"){const s=document.createElement("div"),i=document.createElement("span");i.textContent=e,t==="error"&&(i.style.color="red"),s.appendChild(i),s.style.lineHeight="16px",this.chatMessages.append(s),this.chatMessages.scrollTop=this.chatMessages.scrollHeight}async saveState(){this.storageKey&&(Save_Code3=genSaveCode(0),await Ct(this.storageKey,{receivedItems:this.receivedItems,stages:Stage_Status,save:GameSave("0"),bookHints:this.bookHints??{},randomizedBookCosts:this.randomizedBookCosts??{},deathMouseItem:this.deathMouseItem??{},connectMouseItem:this.connectMouseItem??{},enemyIdsSent:Array.isArray(window.ArchipelagoMod.enemyIdsSent)?Array.from(window.ArchipelagoMod.enemyIdsSent)??[]:[]}))}isNumber(e){return typeof e=="number"}_onUnload(){var e;(e=this.client)==null||e.socket.disconnect()}restoreStagesBeaten(e){for(let t=0;t<e.length;t++)Stage_Status[t]|=e[t];return antiCheatSet(),Stage_Status}createRandomizedBookCosts(e){const t={},s=Stage_Status.length;switch(e){case 1:{for(let i=0;i<s;i++){const o=100*i,c=4e3*i,l=Math.pow(Math.random(),1.5),d=o+l*(c-o);t[i]=Math.max(1,Math.floor(d))}return t}case 2:{for(let i=0;i<s;i++)t[i]=Math.floor(Math.random()*99999)+1;return t}case 3:{for(let i=0;i<s;i++)t[i]=Math.floor(Math.random()*999999)+1;return t}case 0:default:return{}}}isEmpty(e){for(const t in e)if(Object.hasOwn(e,t))return!1;return!0}die(e,t){this.log(`You died from ${e}'s death${t?`: ${t}`:""}.`,"error");for(let s=0;s<4;s++)LP_Current[s]=0;this.deathLinkSource="",this.deathLinkTime="",this.deathLinkCause="",antiCheatSet()}async _connect(){var l;this.client=new bt;const e=this.host.value,t=parseInt(this.port.value),s="Stick Ranger",i=this.slotName.value,o=this.password.value,c=`${e}:${t}`;this.storageKey=[e,t,s,i].join(":"),this.client.socket.on("receivedItems",async d=>{const m=d.items.map(p=>p.item),y=d.index===0&&d.items.length>1&&this.receivedItems.length>0;for(const p of m)await this._applyItem(p,!1);if(y){const p=[...m];for(const f of this.receivedItems){const O=p.indexOf(f);O!==-1&&p.splice(O,1)}for(const f of p)f>=this.TRAPS_OFFSET||d.items[0].flags===4?await this._applyTrap(f):await this._applyItem(f,!0)}else for(const p of m)p>=this.TRAPS_OFFSET||d.items[0].flags===4?await this._applyTrap(p):await this._applyItem(p,!0)}),this.client.socket.on("locationInfo",d=>{d.locations.forEach(m=>{if(m.location>=this.BOOK_OFFSET&&m.location<this.BOOK_OFFSET+100){const y=m.location-this.BOOK_OFFSET;this.bookHints[y]={player:this.client.players.findPlayer(m.player).name,item:this.client.package.lookupItemName(this.client.players.findPlayer(m.player).game,m.item),itemClassification:m.flags}}})}),this.client.socket.on("printJSON",d=>{const m=document.createElement("div");if(d.item){const y=d.item.player;d.data.forEach(p=>{var O;const f=document.createElement("span");if(p.type==="player_id"){const ze=Number(p.text);f.textContent=(O=this.client.players.findPlayer(ze))==null?void 0:O.name,ze===y?f.style.color="#ee00ee":f.style.color="#eee8cd"}else if(p.type==="item_id")switch(f.textContent=this.client.package.lookupItemName(this.client.players.findPlayer(p.player).game,Number(p.text)),d.item.flags){case 1:f.style.color="#9f79ee";break;case 2:f.style.color="#4f94cd";break;case 4:f.style.color="#ed7b6e";break;case 0:default:f.style.color="#09cbcb";break}else p.type==="location_id"?(f.textContent=this.client.package.lookupLocationName(this.client.players.findPlayer(p.player).game,Number(p.text)),f.style.color="limegreen"):p.text&&(f.textContent=p.text);m.appendChild(f)})}else if(d.type==="CommandResult"){const y=document.createElement("pre");y.textContent=d.data[0].text,y.style.margin=0,m.appendChild(y)}else{const y=document.createElement("span");y.textContent=d.data[0].text,m.appendChild(y)}m.style.lineHeight="16px",this.chatMessages.appendChild(m),this.chatMessages.scrollTop=this.chatMessages.scrollHeight}),this.client.deathLink.on("deathReceived",(d,m,y)=>{this.deathLinkReceived=!0,this.deathLinkPending=!0,this.deathLinkSource=d,this.deathLinkTime=m,this.deathLinkCause=y}),this.client.socket.on("disconnected",async()=>{this._onDisconnect()}),this.client.socket.on("bounced",d=>{console.warn("Bounced"),console.log(d)}),this.client.socket.on("invalidPacket",d=>{console.warn("Invalid packet"),console.log(d)}),this.client.socket.on("connectionRefused",d=>{d.errors.forEach(m=>{this.log(m+"; please verify your connection settings.","error")})});try{const d=await We(this.storageKey);d?(this.receivedItems=d.receivedItems,Stage_Status=this.restoreStagesBeaten(d.stages)):await this.saveState(),this.slotData=await this.client.login(c,i,s,{password:o,itemsHandlingFlags:Ue.all,tags:["AP"],slotData:!0}),this._connected=!0,window.ArchipelagoMod.shuffleEnemies=this.slotData.shuffle_enemies??0,window.ArchipelagoMod.pendingAPItemDrops=[],window.ArchipelagoMod.enemyIdsSent=window.ArchipelagoMod.enemyIdsSent??new Set([]),window.ArchipelagoMod.goldMultiplier=this.slotData.gold_multiplier??1,window.ArchipelagoMod.xpMultiplier=this.slotData.xp_multiplier??1,window.ArchipelagoMod.dropMultiplier=this.slotData.drop_multiplier??1,this.sendShopHints=this.slotData.shop_hints??!1,window.ArchipelagoMod.bookHintSpoiler=this.bookHints??{};const m=this.slotData.randomize_book_costs??0;window.ArchipelagoMod.bookCostRandomizer=m,this.isEmpty(this.randomizedBookCosts)&&(this.randomizedBookCosts=this.createRandomizedBookCosts(m)),window.ArchipelagoMod.randomizedBookCosts=this.randomizedBookCosts??{},this.slotData.death_link&&(this.client.deathLink.enableDeathLink(),this.client.updateTags(["AP","DeathLink"])),Item_Inv[this.MOUSE_SLOT]&&(this.connectMouseItem={itemId:Item_Inv[this.MOUSE_SLOT],compo1:Comp1_Inv[this.MOUSE_SLOT],compo2:Comp2_Inv[this.MOUSE_SLOT]},Item_Inv[this.MOUSE_SLOT]=0,Comp1_Inv[this.MOUSE_SLOT]=0,Comp2_Inv[this.MOUSE_SLOT]=0,antiCheatSet(),await this.saveState(),this.log("Storing mouse item ("+Item_Catalogue[this.connectMouseItem.itemId][0]+") to be recovered when in-game again.","info")),this.chatLine.style.display="flex",antiCheatSet()}catch(d){Array.isArray(d)&&((l=d[0])==null?void 0:l.target)instanceof WebSocket?this.log("Cannot connect to: "+d[0].target.url+" Please check the hostname and port, or the server's online status.","error"):this.log("Unknown error during connection: "+d,"error"),this._connected=!1,Sequence_Step=0,this.apDiv.style.display="flex",this.connectionBox.style.display="none",this.chatLine.style.display="none"}}async sendLocation(e){this._disconnected||!this.client.authenticated||(this.client.check(e),await this.saveState())}async _applyItem(e,t){if(e>=this.LOC_OFFSET&&e<this.LOC_OFFSET+999)Stage_Status[e-this.LOC_OFFSET]|=Unlocked,antiCheatSet();else if(e>=this.ITEM_OFFSET&&e<this.ITEM_OFFSET+999&&t){const s=e-this.ITEM_OFFSET,i=this._firstEmptyInvSlot();i>=0?(this.receivedItems.push(e),Item_Inv[i]=s,antiCheatSet()):this.pendingItems.push(e)}await this.saveState()}isInPlayableSequenceStep(){return[12,52,53,54,55].includes(Sequence_Step)}async _applyTrap(e){if(this.isInPlayableSequenceStep())switch(this.receivedItems.push(e),e){case 13e3:this.unequipItems();break;case 13001:this.loseHalfGold();break;case 13002:this.killRanger();break;case 13003:this.freezeRangers();break;case 13004:this.spawnEnemies();break}else this.pendingTraps.push(e);await this.saveState(),antiCheatSet()}unequipItems(){const e=[4,5,6,7].filter(l=>Item_Inv[l]);if(e.length===0)return;const t=l=>{for(let d=l.length-1;d>0;d--){const m=Math.floor(Math.random()*(d+1));[l[d],l[m]]=[l[m],l[d]]}return l},s=(l,d)=>{const m=Item_Inv[l],y=Comp1_Inv[l],p=Comp2_Inv[l];Item_Inv[d]=m,Comp1_Inv[d]=y,Comp2_Inv[d]=p,Item_Inv[l]=0,Comp1_Inv[l]=0,Comp2_Inv[l]=0,antiCheatSet()},i=()=>{if(e.length>0&&Item_Inv[this.MOUSE_SLOT]===0){const l=e.shift();s(l,this.MOUSE_SLOT),MP_Bar[l]=0,Players.PL_gladr_resid_count[l]=0,antiCheatSet()}},o=[];for(let l=this.INV_START;l<Item_Inv.length;l++)l!==this.MOUSE_SLOT&&!Item_Inv[l]&&o.push(l);t(e),t(o),o.length<4&&Item_Inv[this.MOUSE_SLOT]===0&&i();const c=Math.min(o.length,e.length);for(let l=0;l<c;l++){const d=e.shift();s(d,o[l]),MP_Bar[d]=0,Players.PL_gladr_resid_count[d]=0,antiCheatSet()}}loseHalfGold(){const e=Math.floor(Team_Gold/2);Team_Gold-=e,this.log("You lost $"+e+"!","error"),Indicators.INadd(Players.PL_joint[Selected_Player][0].x,Players.PL_joint[Selected_Player][0].y,0,"-$"+e,16727871),antiCheatSet()}killRanger(){const e=[0,1,2,3].filter(s=>LP_Current[s]>0);if(e.length===0)return;const t=e[Math.floor(Math.random()*e.length)];LP_Current[t]=0,antiCheatSet()}freezeRangers(){for(let e=0;e<Stickmen_Slots;e++){const t=Math.floor(Math.random()*750)+1;Players.PL_frozen_ticks[e]=t,antiCheatSet()}}spawnEnemies(){const e=new Set([40,115,163,244,333,334,335,336,337,339]),t=this.randomRangeInt(3,10);for(let s=0;s<t;s++){let i;do i=this.randomRangeInt(1,338);while(e.has(i));const o=Math.floor(Math.random()*((Win_Width>>3)-4-12+1))+12,c=fiftyfifty(Terrain.TR_low_surface[o],Terrain.TR_high_surface[o]);Enemies.ENadd(o,c,i)}}_firstEmptyInvSlot(){for(let e=this.INV_START;e<Item_Inv.length;e++)if(e!==this.MOUSE_SLOT&&!Item_Inv[e])return e;return-1}async _flushPending(){let e;for(;this.pendingItems.length&&(e=this._firstEmptyInvSlot())>=0;){const t=this.pendingItems.shift();this.receivedItems.push(t);const s=t-this.ITEM_OFFSET;Item_Inv[e]=s,antiCheatSet(),await this.saveState()}}async scoutBooksOnShopOpen(){if(this.slotData.shuffle_books===1){for(let e=0;e<Stage_Status.length;e++)this.excludedBookStages.includes(e)||Stage_Status[e]===3&&!this.bookHints[e]&&this.client.scout([this.BOOK_OFFSET+e],2);await this.saveState()}}_tick(){this._disconnected||this._doTickWork().catch(e=>{console.error("Tick error:",e)}),requestAnimationFrame(this._tick)}async _doTickWork(){var e,t,s;if(this._connected&&this.client&&this.client.authenticated){for(let i=0;i<Stage_Status.length;i++)(this.prevStage[i]&Beaten)===0&&(Stage_Status[i]&Beaten)!==0&&await this.sendLocation(i+this.STAGE_COMPLETE_OFFSET),this.slotData.shuffle_books===1&&(this.prevStage[i]&Booked)===0&&(Stage_Status[i]&Booked)!==0&&await this.sendLocation(i+this.BOOK_OFFSET);if(this.prevStage=[...Stage_Status],await this._flushPending(),this.isInPlayableSequenceStep()&&this.pendingTraps.length!==0)for(;this.pendingTraps.length>0;)this._applyTrap(this.pendingTraps.shift());if(!this.winReported&&(Stage_Status[this.STAGE_TO_WIN]&Beaten)===Beaten&&(this.winReported=!0,(e=this.client)==null||e.goal()),this.client.deathLink.enabled&&(Sequence_Step>=11&&Sequence_Step<=13&&this.deathLinkPending&&(this.deathLinkPending=!1,this.die(this.deathLinkSource,this.deathLinkCause)),Sequence_Step===30&&!this.deathLinkSent&&!this.deathLinkReceived&&(this.log("DeathLink: Sending death to your friends..."),this.deathLinkSent=!0,this.client.deathLink.sendDeathLink(this.slotData.player_name,this.slotData.player_name+" was defeated in Stick Ranger.")),Sequence_Step<6&&(this.deathLinkSent=!1,this.deathLinkReceived=!1,this.deathLinkPending=!1)),Sequence_Step===30&&(Item_Inv[this.MOUSE_SLOT]&&(this.deathMouseItem={itemId:Item_Inv[this.MOUSE_SLOT],compo1:Comp1_Inv[this.MOUSE_SLOT],compo2:Comp2_Inv[this.MOUSE_SLOT]},Item_Inv[this.MOUSE_SLOT]=0,Comp1_Inv[this.MOUSE_SLOT]=0,Comp2_Inv[this.MOUSE_SLOT]=0,antiCheatSet(),await this.saveState(),this.log("Storing mouse item ("+Item_Catalogue[this.deathMouseItem.itemId][0]+") to be recovered when in-game again.","info")),this.pendingTraps=[]),this.isInPlayableSequenceStep()&&((t=this.deathMouseItem)==null?void 0:t.itemId)>0){const i=this._firstEmptyInvSlot();i!==-1&&(Item_Inv[i]=this.deathMouseItem.itemId,Comp1_Inv[i]=this.deathMouseItem.compo1,Comp2_Inv[i]=this.deathMouseItem.compo2,this.deathMouseItem={},antiCheatSet(),await this.saveState(),this.log("Mouse item ("+Item_Catalogue[Item_Inv[i]][0]+") recovered into inventory.","info"))}if(this.isInPlayableSequenceStep()&&((s=this.connectMouseItem)==null?void 0:s.itemId)>0){const i=this._firstEmptyInvSlot();i!==-1&&(Item_Inv[i]=this.connectMouseItem.itemId,Comp1_Inv[i]=this.connectMouseItem.compo1,Comp2_Inv[i]=this.connectMouseItem.compo2,this.connectMouseItem={},antiCheatSet(),await this.saveState(),this.log("Mouse item ("+Item_Catalogue[Item_Inv[i]][0]+") recovered into inventory.","info"))}for(Sequence_Step===54&&!this.isScouting&&this.sendShopHints&&this.slotData.shuffle_books===1&&(this.isScouting=!0,this.scoutBooksOnShopOpen()),Sequence_Step!==54&&this.isScouting&&(this.isScouting=!1),this.newGame&&(this.newGame=!1,this.receivedItems=[]);window.ArchipelagoMod.pendingAPItemDrops.length>0;){const i=window.ArchipelagoMod.pendingAPItemDrops.shift();window.ArchipelagoMod.enemyIdsSent.has(i)||(window.ArchipelagoMod.enemyIdsSent.add(i),await this.sendLocation(i+this.ENEMY_OFFSET))}}Sequence_Step===6&&this.lastSequence===4&&(this.newGame=!0),Sequence_Step>=6&&this._pendingConnect&&!this._connected&&(this._pendingConnect=!1,this._connect()),this.lastSequence=Sequence_Step}randomRangeInt(e,t){return Math.floor(Math.random()*(t-e+1))+e}}window.ap=new Mt;
