import{Client as p,ITEMS_HANDLING_FLAGS as S,SERVER_PACKET_TYPE as c,CLIENT_PACKET_TYPE as d}from"https://unpkg.com/archipelago.js@1.0.0/dist/archipelago.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))s(e);new MutationObserver(e=>{for(const o of e)if(o.type==="childList")for(const n of o.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function i(e){const o={};return e.integrity&&(o.integrity=e.integrity),e.referrerPolicy&&(o.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?o.credentials="include":e.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(e){if(e.ep)return;e.ep=!0;const o=i(e);fetch(e.href,o)}})();function m(){return new Promise((r,t)=>{const i=indexedDB.open("StickRangerAP",1);i.onupgradeneeded=()=>i.result.createObjectStore("savegames"),i.onsuccess=()=>r(i.result),i.onerror=()=>t(i.error)})}async function u(r){const t=await m();return new Promise((i,s)=>{const o=t.transaction("savegames","readonly").objectStore("savegames").get(r);o.onsuccess=()=>i(o.result),o.onerror=()=>s(o.error)})}async function g(r,t){const i=await m();return new Promise((s,e)=>{const o=i.transaction("savegames","readwrite");o.objectStore("savegames").put(t,r),o.oncomplete=()=>s(),o.onerror=()=>e(o.error)})}class f{constructor(){this.STAGE_COMPLETE_OFFSET=1e4,this.BOOK_OFFSET=10100,this.LOC_OFFSET=11e3,this.ITEM_OFFSET=12e3,this.INV_START=16,this.MOUSE_SLOT=40,this.STAGE_TO_WIN=88,this._pendingConnect=!1,this._connected=!1,this.receivedItems=[],this.pendingItems=[],this.prevStage=[...Stage_Status],this.winReported=!1,this.lastSequence=-1,this.storageKey="",this.sendShopHints=!1,this.isScouting=!1,this.excludedBookStages=[0,20,47,70,77],this.bookHints={},this.randomizedBookCosts={},this.host=document.getElementById("host"),this.port=document.getElementById("port"),this.slotName=document.getElementById("slotName"),this.password=document.getElementById("password"),this.connect=document.getElementById("connect"),this.chat=document.getElementById("chat"),this.apDiv=document.getElementById("APConnection"),this.connect.addEventListener("click",()=>this._onConnectClick()),window.addEventListener("beforeunload",async()=>await this._onUnload()),this._tick=this._tick.bind(this),requestAnimationFrame(this._tick)}async _onConnectClick(){this.storageKey=[this.host.value,this.port.value,"Stick Ranger",this.slotName.value].join(":");const t=await u(this.storageKey);t&&(this.receivedItems=t.receivedItems,this.bookHints=t.bookHints??{},this.randomizedBookCosts=t.randomizedBookCosts??{},GameLoad(t.save.replace(/\r\n|\r|\n/g,""))),this._pendingConnect=!0,this.apDiv.style.display="none",this.log("Waiting for the game to enter the map...","info")}log(t,i="info"){const s=document.createElement("div");s.textContent=t,i==="error"&&(s.style.color="red"),this.chat.append(s),this.chat.scrollTop=this.chat.scrollHeight}async saveState(){this.storageKey&&await g(this.storageKey,{receivedItems:this.receivedItems,stages:Stage_Status,save:GameSave("0"),bookHints:this.bookHints??{},randomizedBookCosts:this.randomizedBookCosts??{}})}async _onUnload(){var t;await this.saveState(),(t=this.client)==null||t.disconnect()}restoreStagesBeaten(t){for(let i=0;i<t.length;i++)Stage_Status[i]|=t[i];return antiCheatSet(),Stage_Status}createRandomizedBookCosts(t){const i={},s=Stage_Status.length;switch(t){case 1:{for(let e=0;e<s;e++){const o=100*e,n=4e3*e,a=Math.pow(Math.random(),1.5),l=o+a*(n-o);i[e]=Math.max(1,Math.floor(l))}return i}case 2:{for(let e=0;e<s;e++)i[e]=Math.floor(Math.random()*99999)+1;return i}case 3:{for(let e=0;e<s;e++)i[e]=Math.floor(Math.random()*999999)+1;return i}case 0:default:return{}}}isEmpty(t){for(const i in t)if(Object.hasOwn(t,i))return!1;return!0}async _connect(){var i;this.client=new p;const t={hostname:this.host.value,port:parseInt(this.port.value),game:"Stick Ranger",name:this.slotName.value,password:this.password.value,items_handling:S.REMOTE_ALL};this.storageKey=[t.hostname,t.port,t.game,t.name].join(":"),this.client.addListener(c.CONNECTED,async()=>{const s=await u(this.storageKey);s?(this.receivedItems=s.receivedItems,Stage_Status=this.restoreStagesBeaten(s.stages)):await this.saveState();const e=this.client.data.slotData.gold_multiplier??1;window.ArchipelagoMod.goldMultiplier=e;const o=this.client.data.slotData.xp_multiplier??1;window.ArchipelagoMod.xpMultiplier=o;const n=this.client.data.slotData.drop_multiplier??1;window.ArchipelagoMod.dropMultiplier=n,this.sendShopHints=this.client.data.slotData.shop_hints??!1,window.ArchipelagoMod.bookHintSpoiler=this.bookHints??{};const a=this.client.data.slotData.randomize_book_costs??0;window.ArchipelagoMod.bookCostRandomizer=a,this.isEmpty(this.randomizedBookCosts)&&(this.randomizedBookCosts=this.createRandomizedBookCosts(a)),window.ArchipelagoMod.randomizedBookCosts=this.randomizedBookCosts??{}}),this.client.addListener(c.RECEIVED_ITEMS,async s=>{if(s.items.length>1||s.items.length===1&&s.items[0].item===this.receivedItems[0]){const e=s.items.map(n=>n.item);for(const n of e)await this._applyItem(n,!1);let o=e.filter(n=>!this.receivedItems.includes(n));for(const n of o)await this._applyItem(n,!0)}else await this._applyItem(s.items[0].item,!0)}),this.client.addListener(c.LOCATION_INFO,s=>{s.locations.forEach(e=>{if(e.location>=this.BOOK_OFFSET&&e.location<this.BOOK_OFFSET+100){const o=e.location-this.BOOK_OFFSET;this.bookHints[o]={player:this.client.players.name(e.player),item:this.client.items.name(this.client.players.game(e.player),e.item),itemClassification:e.flags}}})}),this.client.addListener(c.PRINT_JSON,s=>{const e=document.createElement("div"),o=Number(this.client.data.slotData.player_id);s.data.forEach(n=>{const a=document.createElement("span"),l=n.player??o;if(n.type==="player_id"){const h=Number(n.text);a.textContent=this.client.players.name(h),h===o?a.style.color="#ee00ee":a.style.color="#eee8cd"}else if(n.type==="item_id")switch(a.textContent=this.client.items.name(this.client.players.game(l),Number(n.text)),s.item.flags){case 1:a.style.color="#9f79ee";break;case 2:a.style.color="#4f94cd";break;case 4:a.style.color="#ed7b6e";break;case 0:default:a.style.color="#09cbcb";break}else n.type==="location_id"?(a.textContent=this.client.locations.name(this.client.players.game(l),Number(n.text)),a.style.color="limegreen"):n.text&&(a.textContent=n.text);e.appendChild(a)}),this.chat.appendChild(e),this.chat.scrollTop=this.chat.scrollHeight}),this.client.addListener(c.CONNECTION_REFUSED,s=>{s.errors.forEach(e=>{this.log(e+"; please verify your connection settings.","error")})});try{await this.client.connect(t),this._connected=!0}catch(s){Array.isArray(s)&&((i=s[0])==null?void 0:i.target)instanceof WebSocket?this.log("Cannot connect to: "+s[0].target.url+" Please check the hostname and port, or the server's online status.","error"):this.log("Unknown error during connection: "+s,"error"),this._connected=!1,Sequence_Step=0,this.apDiv.style.display="flex"}}async sendLocation(t){this.client&&this.client.locations.check(t),await this.saveState()}async _applyItem(t,i){if(i&&this.receivedItems.push(t),t>=this.LOC_OFFSET&&t<this.LOC_OFFSET+999)Stage_Status[t-this.LOC_OFFSET]|=Unlocked;else if(t>=this.ITEM_OFFSET&&t<this.ITEM_OFFSET+999&&i){const s=t-this.ITEM_OFFSET,e=this._firstEmptyInvSlot();e>=0?Item_Inv[e]=s:this.pendingItems.push(s)}antiCheatSet(),await this.saveState()}_firstEmptyInvSlot(){for(let t=this.INV_START;t<Item_Inv.length;t++)if(t!==this.MOUSE_SLOT&&!Item_Inv[t])return t;return-1}async _flushPending(){let t;for(;this.pendingItems.length&&(t=this._firstEmptyInvSlot())>=0;)Item_Inv[t]=this.pendingItems.shift(),await this.saveState(),antiCheatSet()}async scoutBooksOnShopOpen(){var t;for(let i=0;i<Stage_Status.length;i++)this.excludedBookStages.includes(i)||Stage_Status[i]===3&&!this.bookHints[i]&&((t=this.client)==null||t.send({cmd:d.LOCATION_SCOUTS,create_as_hint:2,locations:[this.BOOK_OFFSET+i]}))}_tick(){this._doTickWork().catch(t=>{console.error("Tick error:",t)}),requestAnimationFrame(this._tick)}async _doTickWork(){var t,i;for(let s=0;s<Stage_Status.length;s++)(this.prevStage[s]&Beaten)===0&&(Stage_Status[s]&Beaten)!==0&&await this.sendLocation(s+this.STAGE_COMPLETE_OFFSET),(this.prevStage[s]&Booked)===0&&(Stage_Status[s]&Booked)!==0&&await this.sendLocation(s+10100);this.prevStage=[...Stage_Status],await this._flushPending(),!this.winReported&&(Stage_Status[this.STAGE_TO_WIN]&Beaten)===Beaten&&(this.winReported=!0,(t=this.client)==null||t.send({cmd:"StatusUpdate",status:30})),Sequence_Step===6&&this.lastSequence===4&&((i=this.client)==null||i.send({cmd:d.SYNC})),Sequence_Step===6&&this._pendingConnect&&!this._connected&&(this._pendingConnect=!1,this._connect()),Sequence_Step===54&&!this.isScouting&&this.sendShopHints&&(this.isScouting=!0,this.scoutBooksOnShopOpen()),Sequence_Step!==54&&this.isScouting&&(this.isScouting=!1),this.lastSequence=Sequence_Step}}window.ap=new f;
