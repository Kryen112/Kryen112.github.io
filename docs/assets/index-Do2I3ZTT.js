var Yt=Object.defineProperty;var Ht=a=>{throw TypeError(a)};var te=(a,e,t)=>e in a?Yt(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var l=(a,e,t)=>te(a,typeof e!="symbol"?e+"":e,t),Bt=(a,e,t)=>e.has(a)||Ht("Cannot "+t);var i=(a,e,t)=>(Bt(a,e,"read from private field"),t?t.call(a):e.get(a)),h=(a,e,t)=>e.has(a)?Ht("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(a):e.set(a,t),r=(a,e,t,s)=>(Bt(a,e,"write to private field"),s?s.call(a,t):e.set(a,t),t),D=(a,e,t)=>(Bt(a,e,"access private method"),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const c of o.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&s(c)}).observe(document,{childList:!0,subtree:!0});function t(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(n){if(n.ep)return;n.ep=!0;const o=t(n);fetch(n.href,o)}})();var ee=Object.defineProperty,se=(a,e)=>{for(var t in e)ee(a,t,{get:e[t],enumerable:!0,configurable:!0,set:s=>e[t]=()=>s})},ie={};se(ie,{slotTypes:()=>Et,permissions:()=>ne,itemsHandlingFlags:()=>Ut,itemClassifications:()=>O,clientStatuses:()=>Dt});var Dt={disconnected:0,connected:5,ready:10,playing:20,goal:30},O={progression:1,useful:2,trap:4,none:0},Ut={minimal:0,others:1,own:2,starting:4,all:7},ne={disabled:0,enabled:1,goal:2,auto:6,autoEnabled:7},Et={spectator:0,player:1,group:2};class J extends Error{}class oe extends Error{constructor(t,s,n){super(t);l(this,"argumentName");l(this,"value");this.argumentName=s,this.value=structuredClone(n)}}class ae extends Error{constructor(t,s){super(t);l(this,"errors",[]);this.errors=s}}class M extends Error{}var $t={timeout:1e4,autoFetchDataPackage:!0,maximumMessages:1e3,debugLogVersions:!0},re={major:0,minor:5,build:1},he="2.0.4";function zt(){const a=[];for(let e=0;e<36;e++)a.push(Math.floor(Math.random()*16));return a[14]=4,a[19]=a[19]&=-5,a[19]=a[19]|=8,a[8]=a[13]=a[18]=a[23]="-",a.map(e=>e.toString(16)).join("")}var Rt={password:"",uuid:zt(),tags:[],version:re,items:Ut.all,slotData:!0},Z,x,lt,dt;class V{constructor(e,t,s,n){h(this,Z);h(this,x);h(this,lt);h(this,dt);r(this,Z,e),r(this,x,t),r(this,lt,s),r(this,dt,n)}toString(){return this.name}get receiver(){return i(this,dt)}get sender(){return i(this,lt)}get name(){return i(this,Z).package.lookupItemName(this.game,i(this,x).item,!0)}get id(){return i(this,x).item}get locationName(){return i(this,Z).package.lookupLocationName(this.sender.game,i(this,x).location,!0)}get locationId(){return i(this,x).location}get locationGame(){return this.sender.game}get game(){return this.receiver.game}get progression(){return(this.flags&O.progression)===O.progression}get useful(){return(this.flags&O.useful)===O.useful}get trap(){return(this.flags&O.trap)===O.trap}get filler(){return this.flags===O.none}get flags(){return i(this,x).flags}}Z=new WeakMap,x=new WeakMap,lt=new WeakMap,dt=new WeakMap;class Wt{constructor(e,t){l(this,"game");l(this,"checksum");l(this,"itemTable");l(this,"locationTable");l(this,"reverseItemTable");l(this,"reverseLocationTable");this.game=e,this.checksum=t.checksum,this.itemTable=Object.freeze(t.item_name_to_id),this.locationTable=Object.freeze(t.location_name_to_id),this.reverseItemTable=Object.freeze(Object.fromEntries(Object.entries(this.itemTable).map(([s,n])=>[n,s]))),this.reverseLocationTable=Object.freeze(Object.fromEntries(Object.entries(this.locationTable).map(([s,n])=>[n,s])))}exportPackage(){return{checksum:this.checksum,item_name_to_id:{...this.itemTable},location_name_to_id:{...this.locationTable}}}}var Q,T,U,z,Lt,Gt;class ce{constructor(e){h(this,Lt);h(this,Q);h(this,T,new Map);h(this,U,new Map);h(this,z,new Set);r(this,Q,e),i(this,Q).socket.on("roomInfo",t=>{i(this,T).clear(),i(this,U).clear(),i(this,z).clear(),i(this,T).set("Archipelago",D(this,Lt,Gt).call(this));for(const s in t.datapackage_checksums)i(this,U).set(s,t.datapackage_checksums[s]),i(this,z).add(s)})}findPackage(e){return i(this,T).get(e)??null}async fetchPackage(e=[],t=!0){e.length===0&&(e=Array.from(i(this,z))),e=e.filter(n=>{var o;return i(this,z).has(n)?((o=i(this,T).get(n))==null?void 0:o.checksum)!==i(this,U).get(n):!1});const s={games:{}};for(const n of e){const o={cmd:"GetDataPackage",games:[n]},[c]=await i(this,Q).socket.send(o).wait("dataPackage");s.games[n]=c.data.games[n]}return t&&this.importPackage(s),s}importPackage(e){for(const t in e.games)i(this,T).set(t,new Wt(t,e.games[t])),i(this,U).set(t,e.games[t].checksum)}exportPackage(){return{games:i(this,T).entries().reduce((e,[t,s])=>(e[t]=s.exportPackage(),e),{})}}lookupItemName(e,t,s=!0){const n=`Unknown Item ${t}`,o=this.findPackage(e);if(!o)return s?n:void 0;const c=o.reverseItemTable[t];return s&&c===void 0?n:c}lookupLocationName(e,t,s=!0){const n=`Unknown Location ${t}`,o=this.findPackage(e);if(!o)return s?n:void 0;const c=o.reverseLocationTable[t];return s&&c===void 0?n:c}}Q=new WeakMap,T=new WeakMap,U=new WeakMap,z=new WeakMap,Lt=new WeakSet,Gt=function(){return new Wt("Archipelago",{checksum:"ac9141e9ad0318df2fa27da5f20c50a842afeecb",item_name_to_id:{Nothing:-1},location_name_to_id:{"Cheat Console":-1,Server:-2}})};var X,p,ut,mt;class le{constructor(e,t,s){h(this,X);h(this,p,[]);h(this,ut);h(this,mt);r(this,X,e),r(this,ut,t),r(this,mt,s)}replace(e){return i(this,p).push({operation:"replace",value:e}),this}default(){return i(this,p).push({operation:"default",value:null}),this}add(e){return i(this,p).push({operation:"add",value:e}),this}multiply(e){return i(this,p).push({operation:"mul",value:e}),this}power(e){return i(this,p).push({operation:"pow",value:e}),this}remainder(e){return i(this,p).push({operation:"mod",value:e}),this}floor(){return i(this,p).push({operation:"floor",value:null}),this}ceiling(){return i(this,p).push({operation:"ceil",value:null}),this}max(e){return i(this,p).push({operation:"max",value:e}),this}min(e){return i(this,p).push({operation:"min",value:e}),this}and(e){return i(this,p).push({operation:"and",value:e}),this}or(e){return i(this,p).push({operation:"or",value:e}),this}xor(e){return i(this,p).push({operation:"xor",value:e}),this}leftShift(e){return i(this,p).push({operation:"left_shift",value:e}),this}rightShift(e){return i(this,p).push({operation:"right_shift",value:e}),this}remove(e){return i(this,p).push({operation:"remove",value:e}),this}pop(e){return i(this,p).push({operation:"pop",value:e}),this}update(e){return i(this,p).push({operation:"update",value:e}),this}async commit(e=!1){const t=zt(),s={cmd:"Set",default:i(this,mt),key:i(this,ut),operations:i(this,p),want_reply:e,uuid:t};if(i(this,X).socket.send(s),!e)return;const[n]=await i(this,X).socket.wait("setReply",o=>o.uuid===t);return n.value}}X=new WeakMap,p=new WeakMap,ut=new WeakMap,mt=new WeakMap;var P,I,j,Ot,Kt;class de{constructor(e){h(this,Ot);h(this,P);h(this,I,{});h(this,j,{});r(this,P,e),i(this,P).socket.on("disconnected",()=>{r(this,I,{}),r(this,j,{})}).on("setReply",t=>{i(this,I)[t.key]=t.value;const s=i(this,j)[t.key];s&&s.forEach(n=>n(t.key,t.value,t.original_value))}).on("connected",()=>{if(i(this,P).options.debugLogVersions){const t=`${i(this,P).game}:${he}:${navigator==null?void 0:navigator.userAgent}`;this.prepare("archipelago.js__runtimes",{}).default().update({[t]:!0}).commit(!1)}})}get store(){return structuredClone(i(this,I))}async fetch(e,t=!1){let s=typeof e=="string"?[e]:e;if(t){const o=s.filter(c=>i(this,I)[c]===void 0);o.length>0&&i(this,P).socket.send({cmd:"SetNotify",keys:o})}let n={};if(s=s.filter(o=>{const c=structuredClone(i(this,I)[o]),f=c!==void 0;return f&&(n[o]=c),!f}),s.length>0){const o=await D(this,Ot,Kt).call(this,s);n={...n,...o}}return t&&r(this,I,{...i(this,I),...n}),typeof e=="string"?n[e]:n}async notify(e,t){return e.forEach(s=>{var n;(n=i(this,j))[s]??(n[s]=[]),i(this,j)[s].push(t)}),this.fetch(e,!0)}prepare(e,t){if(e.startsWith("_read_"))throw TypeError("Cannot manipulate read only keys.");return new le(i(this,P),e,t)}async fetchItemNameGroups(e){return await this.fetch([`_read_item_name_groups_${e}`],!0)}async fetchLocationNameGroups(e){return await this.fetch([`_read_location_name_groups_${e}`],!0)}}P=new WeakMap,I=new WeakMap,j=new WeakMap,Ot=new WeakSet,Kt=async function(e){const t=zt(),[s]=await i(this,P).socket.send({cmd:"Get",keys:e,uuid:t}).wait("retrieved",n=>n.uuid===t);return s.keys};var N;class ue{constructor(){h(this,N,{})}addEventListener(e,t,s=!1){var n;(n=i(this,N))[e]??(n[e]=[]),i(this,N)[e].push([t,s])}removeEventListener(e,t){const s=i(this,N)[e];s&&s.length>0&&(i(this,N)[e]=s.filter(([n])=>n!==t))}dispatchEvent(e,t){const s=i(this,N)[e]??[];for(const[n,o]of s)n(...t),o&&this.removeEventListener(e,n)}}N=new WeakMap;var F;class ht{constructor(){h(this,F,new ue)}on(e,t){return i(this,F).addEventListener(e,t),this}off(e,t){return i(this,F).removeEventListener(e,t),this}async wait(e,t=()=>!0){return new Promise(s=>{const n=(...o)=>{t(...o)&&(i(this,F).removeEventListener(e,n),s(o))};i(this,F).addEventListener(e,n)})}emit(e,t){i(this,F).dispatchEvent(e,t)}}F=new WeakMap;var v,H;class me extends ht{constructor(t){super();h(this,v);h(this,H,Number.MIN_SAFE_INTEGER);r(this,v,t),i(this,v).socket.on("bounced",s=>{var n;if((n=s.tags)!=null&&n.includes("DeathLink")&&s.data.time&&s.data.source){const o=s.data;if(o.time===i(this,H))return;r(this,H,o.time),this.emit("deathReceived",[o.source,o.time*1e3,o.cause])}})}get enabled(){return i(this,v).arguments.tags.includes("DeathLink")}enableDeathLink(){i(this,v).arguments.tags.includes("DeathLink")||i(this,v).updateTags([...i(this,v).arguments.tags,"DeathLink"])}disableDeathLink(){i(this,v).arguments.tags.includes("DeathLink")&&i(this,v).updateTags(i(this,v).arguments.tags.filter(t=>t!=="DeathLink"))}sendDeathLink(t,s){if(!i(this,v).authenticated)throw new M("Cannot send death links before connecting and authenticating.");if(!this.enabled)return;r(this,H,Math.ceil(Date.now()/1e3));const n={source:t,cause:s,time:i(this,H)};i(this,v).bounce({tags:["DeathLink"]},n)}}v=new WeakMap,H=new WeakMap;var $,Y,gt;class xt{constructor(e,t){h(this,$);h(this,Y);h(this,gt);r(this,$,e),r(this,Y,t),r(this,gt,new V(i(this,$),{item:t.item,location:t.location,player:t.finding_player,flags:t.item_flags},i(this,$).players.findPlayer(t.finding_player),i(this,$).players.findPlayer(t.receiving_player)))}get item(){return i(this,gt)}get found(){return i(this,Y).found}get entrance(){return i(this,Y).entrance||"Vanilla"}}$=new WeakMap,Y=new WeakMap,gt=new WeakMap;var _,A,k,Mt,Vt;class ge extends ht{constructor(t){super();h(this,Mt);h(this,_);h(this,A,[]);h(this,k,[]);r(this,_,t),i(this,_).socket.on("receivedItems",s=>{let n=s.index;const o=s.items.length,c=[...s.items];for(;c.length>0;){const f=c.shift();i(this,A)[n++]=new V(i(this,_),f,i(this,_).players.findPlayer(f.player),i(this,_).players.self)}this.emit("itemsReceived",[i(this,A).slice(s.index,s.index+o),s.index])}).on("connected",()=>{r(this,k,[]),r(this,A,[]),i(this,_).storage.notify([`_read_hints_${i(this,_).players.self.team}_${i(this,_).players.self.slot}`],D(this,Mt,Vt).bind(this)).then(s=>{const n=s[`_read_hints_${i(this,_).players.self.team}_${i(this,_).players.self.slot}`];r(this,k,n.map(o=>new xt(i(this,_),o))),this.emit("hintsInitialized",[i(this,k)])}).catch(s=>{throw s})})}get received(){return[...i(this,A)]}get hints(){return[...i(this,k)]}get count(){return i(this,A).length}}_=new WeakMap,A=new WeakMap,k=new WeakMap,Mt=new WeakSet,Vt=function(t,s){for(let n=0;n<s.length;n++)i(this,k)[n]===void 0?(i(this,k)[n]=new xt(i(this,_),s[n]),this.emit("hintReceived",[i(this,k)[n]])):i(this,k)[n].found!==s[n].found&&(i(this,k)[n]=new xt(i(this,_),s[n]),this.emit("hintFound",[i(this,k)[n]]))};class Pt{constructor(e,t){l(this,"client");l(this,"part");this.client=e,this.part=t}toString(){return this.text}}class fe extends Pt{constructor(t,s,n,o){super(t,s);l(this,"part");l(this,"type","item");l(this,"item");const c=t.players.findPlayer(s.player,o.team);this.part=s,this.item=new V(t,n,c,o)}get text(){return this.item.name}}var tt;class pe extends Pt{constructor(t,s){super(t,s);h(this,tt);l(this,"part");l(this,"type","location");l(this,"id");const n=t.players.findPlayer(s.player),o=t.package.findPackage(n.game);this.part=s,s.type==="location_name"?(r(this,tt,s.text),this.id=o.locationTable[s.text]):(this.id=parseInt(s.text),r(this,tt,t.package.lookupLocationName(n.game,this.id,!0)))}get text(){return i(this,tt)}}tt=new WeakMap;class ye extends Pt{constructor(t,s){super(t,s);l(this,"part");l(this,"type","color");l(this,"color");this.part=s,this.color=s.color}get text(){return this.part.text}}class _e extends Pt{constructor(t,s){super(t,s);l(this,"part");l(this,"type");this.part=s,this.part.type==="entrance_name"?this.type="entrance":this.type="text"}get text(){return this.part.text}}class we extends Pt{constructor(t,s){super(t,s);l(this,"part");l(this,"type","player");l(this,"player");if(this.part=s,s.type==="player_id")this.player=t.players.findPlayer(parseInt(s.text));else{const n=t.players.teams[t.players.self.team].find(o=>o.name===s.text);if(!n)throw new Error(`Cannot find player under name: ${s.text}`);this.player=n}}get text(){return this.player.alias}}var d,Nt,Ft,Jt;class Se extends ht{constructor(t){super();h(this,Ft);h(this,d);h(this,Nt,[]);r(this,d,t),i(this,d).socket.on("printJSON",D(this,Ft,Jt).bind(this))}get log(){return[...i(this,Nt)]}async say(t){if(!i(this,d).authenticated)throw new M("Cannot send chat messages without being authenticated.");t=t.trim();const s={cmd:"Say",text:t};i(this,d).socket.send(s),await this.wait("chat",n=>n===t)}}d=new WeakMap,Nt=new WeakMap,Ft=new WeakSet,Jt=function(t){const s=[];for(const o of t.data)switch(o.type){case"item_id":case"item_name":{const c=t;let f;c.type==="ItemCheat"?f=i(this,d).players.findPlayer(c.receiving,c.team):f=i(this,d).players.findPlayer(c.receiving),s.push(new fe(i(this,d),o,c.item,f));break}case"location_id":case"location_name":{s.push(new pe(i(this,d),o));break}case"color":{s.push(new ye(i(this,d),o));break}case"player_id":case"player_name":{s.push(new we(i(this,d),o));break}default:{s.push(new _e(i(this,d),o));break}}const n=s.map(o=>o.text).join();switch(i(this,d).options.maximumMessages>=1&&(this.log.push({text:n,nodes:s}),this.log.splice(0,this.log.length-i(this,d).options.maximumMessages)),t.type){case"ItemSend":{const o=i(this,d).players.findPlayer(t.item.player),c=i(this,d).players.findPlayer(t.receiving),f=new V(i(this,d),t.item,o,c);this.emit("itemSent",[n,f,s]);break}case"ItemCheat":{const o=i(this,d).players.findPlayer(t.item.player,t.team),c=i(this,d).players.findPlayer(t.receiving,t.team),f=new V(i(this,d),t.item,o,c);this.emit("itemCheated",[n,f,s]);break}case"Hint":{const o=i(this,d).players.findPlayer(t.item.player),c=i(this,d).players.findPlayer(t.receiving),f=new V(i(this,d),t.item,o,c);this.emit("itemHinted",[n,f,t.found,s]);break}case"Join":{const o=i(this,d).players.findPlayer(t.slot,t.team);this.emit("connected",[n,o,t.tags,s]);break}case"Part":{const o=i(this,d).players.findPlayer(t.slot,t.team);this.emit("disconnected",[n,o,s]);break}case"Chat":{const o=i(this,d).players.findPlayer(t.slot,t.team);this.emit("chat",[t.message,o,s]);break}case"ServerChat":{this.emit("serverChat",[t.message,s]);break}case"TagsChanged":{const o=i(this,d).players.findPlayer(t.slot,t.team);this.emit("tagsUpdated",[n,o,t.tags,s]);break}case"Tutorial":{this.emit("tutorial",[n,s]);break}case"CommandResult":{this.emit("userCommand",[n,s]);break}case"AdminCommandResult":{this.emit("adminCommand",[n,s]);break}case"Goal":{const o=i(this,d).players.findPlayer(t.slot,t.team);this.emit("goaled",[n,o,s]);break}case"Release":{const o=i(this,d).players.findPlayer(t.slot,t.team);this.emit("released",[n,o,s]);break}case"Collect":{const o=i(this,d).players.findPlayer(t.slot,t.team);this.emit("collected",[n,o,s]);break}case"Countdown":this.emit("countdown",[n,t.countdown,s])}this.emit("message",[n,s])};var C,B,et,Tt;class It{constructor(e,t){h(this,et);h(this,C);h(this,B);r(this,C,e),r(this,B,t)}toString(){return this.alias}get name(){return i(this,B).name}get alias(){return i(this,B).alias}get game(){return this.slot===0?"Archipelago":i(this,et,Tt).game}get type(){return this.slot===0?Et.spectator:i(this,et,Tt).type}get team(){return i(this,B).team}get slot(){return i(this,B).slot}get members(){return this.type!==Et.group?[]:i(this,C).players.teams[this.team].filter(e=>i(this,et,Tt).group_members.includes(e.slot))}get groups(){return this.slot===0?[]:i(this,C).players.teams[this.team].filter(e=>e.slot!==0&&i(this,C).players.slots[e.slot].group_members.includes(this.slot))}async fetchStatus(){return this.type===Et.group?Dt.goal:await i(this,C).storage.fetch(`_read_client_status_${this.team}_${this.slot}`)??0}async fetchSlotData(){return await i(this,C).storage.fetch(`_read_slot_data_${this.slot}`)}async fetchHints(){return(await i(this,C).storage.fetch(`_read_hints_${this.team}_${this.slot}`)).map(t=>new xt(i(this,C),t))}}C=new WeakMap,B=new WeakMap,et=new WeakSet,Tt=function(){return i(this,C).players.slots[this.slot]};var E,S,ft,st,pt;class be extends ht{constructor(t){super();h(this,E);h(this,S,[]);h(this,ft,{});h(this,st,0);h(this,pt,0);r(this,E,t),i(this,E).socket.on("connected",s=>{var n,o;r(this,ft,Object.freeze(s.slot_info)),r(this,S,[]),r(this,st,s.slot),r(this,pt,s.team);for(const c of s.players)(n=i(this,S))[o=c.team]??(n[o]=[{team:c.team,slot:0,name:"Archipelago",alias:"Archipelago"}]),i(this,S)[c.team][c.slot]=c}).on("roomUpdate",s=>{if(s.players){for(const n of s.players)if(i(this,S)[n.team][n.slot].alias!==n.alias){const o=i(this,S)[n.team][n.slot].alias;i(this,S)[n.team][n.slot]=n,this.emit("aliasUpdated",[new It(i(this,E),n),o,n.alias])}}})}get self(){if(i(this,st)===0)throw new Error("Cannot lookup own player object when client has never connected to a server.");return new It(i(this,E),i(this,S)[i(this,pt)][i(this,st)])}get slots(){return i(this,ft)}get teams(){const t=[];for(let s=0;s<i(this,S).length;s++){t[s]=[];for(let n=0;n<i(this,S)[s].length;n++)t[s].push(new It(i(this,E),i(this,S)[s][n]))}return t}findPlayer(t,s){if(s===void 0&&(s=i(this,E).players.self.team),i(this,S)[s])return new It(i(this,E),i(this,S)[s][t])}}E=new WeakMap,S=new WeakMap,ft=new WeakMap,st=new WeakMap,pt=new WeakMap;var yt,_t,wt,St,bt,vt,it,W,nt,q,G,K,R,At;class ve extends ht{constructor(t){super();h(this,yt);h(this,_t,{major:-1,minor:-1,build:-1});h(this,wt,{major:-1,minor:-1,build:-1});h(this,St,[]);h(this,bt,[]);h(this,vt,"");h(this,it,!1);h(this,W,0);h(this,nt,0);h(this,q,0);h(this,G,{release:0,collect:0,remaining:0});h(this,K,[]);h(this,R,[]);h(this,At,!1);r(this,yt,t),i(this,yt).socket.on("roomInfo",s=>{r(this,_t,{major:s.version.major,minor:s.version.minor,build:s.version.build}),r(this,wt,{major:s.generator_version.major,minor:s.generator_version.minor,build:s.generator_version.build}),r(this,bt,s.tags),r(this,St,s.games),r(this,vt,s.seed_name),r(this,it,s.password),r(this,G,s.permissions),r(this,nt,s.hint_cost),r(this,q,s.location_check_points)}).on("connected",s=>{r(this,K,s.missing_locations),r(this,R,s.checked_locations),this.emit("locationsChecked",[this.checkedLocations]),r(this,W,s.hint_points),this.emit("hintPointsUpdated",[0,s.hint_points])}).on("roomUpdate",s=>{if(s.hint_cost!==void 0){const[n,o]=[this.hintCost,this.hintCostPercentage];r(this,nt,s.hint_cost),this.emit("hintCostUpdated",[n,this.hintCost,o,this.hintCostPercentage])}if(s.hint_points!==void 0){const n=i(this,W);r(this,W,s.hint_points),this.emit("hintPointsUpdated",[n,this.hintPoints])}if(s.location_check_points!==void 0){const n=i(this,q);r(this,q,s.location_check_points),this.emit("locationCheckPointsUpdated",[n,this.locationCheckPoints])}if(s.password!==void 0&&(r(this,it,s.password),this.emit("passwordUpdated",[this.password])),s.permissions!==void 0){const n=i(this,G);r(this,G,s.permissions),this.emit("permissionsUpdated",[n,this.permissions])}s.checked_locations!==void 0&&(r(this,R,[...i(this,R),...s.checked_locations]),r(this,K,this.missingLocations.filter(n=>{var o;return!((o=s.checked_locations)!=null&&o.includes(n))})),this.emit("locationsChecked",[s.checked_locations]))})}get serverVersion(){return{...i(this,_t)}}get generatorVersion(){return{...i(this,wt)}}get games(){return[...i(this,St)]}get tags(){return[...i(this,bt)]}get seedName(){return i(this,vt)}get password(){return i(this,it)}get permissions(){return{...i(this,G)}}get hintPoints(){return i(this,W)}get hintCost(){return this.hintCostPercentage>0?Math.max(1,Math.floor(this.hintCostPercentage*this.allLocations.length*.01)):0}get hintCostPercentage(){return i(this,nt)}get locationCheckPoints(){return i(this,q)}get missingLocations(){return[...i(this,K)].sort()}get checkedLocations(){return[...i(this,R)].sort()}get allLocations(){return[...i(this,K),...i(this,R)].sort()}get race(){return i(this,At)}}yt=new WeakMap,_t=new WeakMap,wt=new WeakMap,St=new WeakMap,bt=new WeakMap,vt=new WeakMap,it=new WeakMap,W=new WeakMap,nt=new WeakMap,q=new WeakMap,G=new WeakMap,K=new WeakMap,R=new WeakMap,At=new WeakMap;var w,ot,rt,Zt,Qt;class ke extends ht{constructor(){super();h(this,rt);h(this,w,null);h(this,ot,!1)}get connected(){return i(this,ot)}get url(){var t;return((t=i(this,w))==null?void 0:t.url)??""}send(...t){if(i(this,w))return i(this,w).send(JSON.stringify(t)),this.emit("sentPackets",[t]),this;throw new J("Unable to send packets to the server; not connected to a server.")}async connect(t){if(this.disconnect(),typeof t=="string"){if(!/^([a-zA-Z]+:)\/\/[A-Za-z0-9_.~\-:]+/i.test(t))try{return await this.connect(new URL(`wss://${t}`))}catch{return await this.connect(new URL(`ws://${t}`))}t=new URL(t)}if(t.port=t.port||"38281",t.protocol!=="wss:"&&t.protocol!=="ws:")throw new TypeError("Unexpected protocol. Archipelago only supports the ws:// and wss:// protocols.");try{return new Promise((s,n)=>{const o=D(this,rt,Qt).call(this);if(o===null)throw new J("Unable to find a suitable WebSocket API in the current runtime.");r(this,w,new o(t)),i(this,w).onmessage=D(this,rt,Zt).bind(this),i(this,w).onclose=()=>{this.disconnect(),n(new J("Failed to connect to Archipelago server."))},i(this,w).onerror=()=>{this.disconnect(),n(new J("Failed to connect to Archipelago server."))},i(this,w).onopen=()=>{this.wait("roomInfo").then(([c])=>{if(r(this,ot,!0),i(this,w)){i(this,w).onclose=this.disconnect.bind(this),i(this,w).onerror=this.disconnect.bind(this),s(c);return}this.disconnect(),n(new J("Failed to connect to Archipelago server."))}).catch(c=>{throw c})}})}catch(s){throw this.disconnect(),s}}disconnect(){var t;this.connected&&(r(this,ot,!1),(t=i(this,w))==null||t.close(),r(this,w,null),this.emit("disconnected",[]))}}w=new WeakMap,ot=new WeakMap,rt=new WeakSet,Zt=function(t){const s=JSON.parse(t.data);for(const n of s){switch(n.cmd){case"ConnectionRefused":this.emit("connectionRefused",[n]);break;case"Bounced":this.emit("bounced",[n,n.data]);break;case"Connected":this.emit("connected",[n]);break;case"DataPackage":this.emit("dataPackage",[n]);break;case"InvalidPacket":this.emit("invalidPacket",[n]);break;case"LocationInfo":this.emit("locationInfo",[n]);break;case"PrintJSON":this.emit("printJSON",[n]);break;case"ReceivedItems":this.emit("receivedItems",[n]);break;case"Retrieved":this.emit("retrieved",[n]);break;case"RoomInfo":this.emit("roomInfo",[n]);break;case"RoomUpdate":this.emit("roomUpdate",[n]);break;case"SetReply":this.emit("setReply",[n]);break}this.emit("receivedPacket",[n])}},Qt=function(){let t=null;return typeof window<"u"?t=window.WebSocket||window.MozWebSocket:typeof global<"u"?t=global.WebSocket||global.MozWebSocket:typeof self<"u"?t=self.WebSocket||self.MozWebSocket:typeof WebSocket<"u"?t=WebSocket:typeof MozWebSocket<"u"&&(t=MozWebSocket),t};var at,L,kt,Ct;class Ce{constructor(e){h(this,at,!1);h(this,L,Rt);h(this,kt,"");h(this,Ct,"");l(this,"socket",new ke);l(this,"package",new ce(this));l(this,"storage",new de(this));l(this,"room",new ve(this));l(this,"players",new be(this));l(this,"items",new ge(this));l(this,"messages",new Se(this));l(this,"deathLink",new me(this));l(this,"options");e?this.options={...$t,...e}:this.options={...$t},this.socket.on("disconnected",()=>{r(this,at,!1)}).on("sentPackets",t=>{for(const s of t)s.cmd==="ConnectUpdate"&&(i(this,L).tags=s.tags,i(this,L).items=s.items_handling)})}get authenticated(){return this.socket.connected&&i(this,at)}get name(){return i(this,kt)}get game(){return i(this,Ct)}get arguments(){return{...i(this,L)}}async login(e,t,s="",n){if(t==="")throw new oe("Provided slot name cannot be blank.","name",t);n?r(this,L,{...Rt,...n}):r(this,L,{...Rt});const o=new Set(this.arguments.tags);!s&&!o.has("HintGame")&&!o.has("Tracker")&&!o.has("TextOnly")&&o.add("TextOnly"),i(this,L).tags=Array.from(o);const c={cmd:"Connect",name:t,game:s,password:this.arguments.password,slot_data:this.arguments.slotData,items_handling:this.arguments.items,uuid:this.arguments.uuid,tags:this.arguments.tags,version:{...this.arguments.version,class:"Version"}};return await this.socket.connect(e),this.options.autoFetchDataPackage&&await this.package.fetchPackage(),new Promise((f,u)=>{const y=setTimeout(()=>u(new J("Server failed to respond in time.")),this.options.timeout),b=g=>{r(this,at,!0),r(this,Ct,g.slot_info[g.slot].game),r(this,kt,g.slot_info[g.slot].name),this.socket.off("connected",b).off("connectionRefused",m),clearTimeout(y),f(g.slot_data)},m=g=>{var ct;this.socket.off("connected",b).off("connectionRefused",m),clearTimeout(y),u(new ae(`Connection was refused by the server. Reason(s): [${(ct=g.errors)==null?void 0:ct.join(", ")}`,g.errors??[]))};this.socket.on("connected",b.bind(this)).on("connectionRefused",m.bind(this)).send(c)})}updateStatus(e){if(!this.authenticated)throw new M("Cannot update status while not connected and authenticated.");this.socket.send({cmd:"StatusUpdate",status:e})}goal(){this.updateStatus(Dt.goal)}updateTags(e){if(!this.authenticated)throw new M("Cannot update tags while not connected and authenticated.");this.socket.send({cmd:"ConnectUpdate",tags:e,items_handling:this.arguments.items})}updateItemsHandling(e){if(!this.authenticated)throw new M("Cannot update tags while not connected and authenticated.");this.socket.send({cmd:"ConnectUpdate",tags:this.arguments.tags,items_handling:e})}check(...e){if(!this.authenticated)throw new M("Cannot check locations while not connected and authenticated.");e=e.filter(t=>this.room.missingLocations.includes(t)),this.socket.send({cmd:"LocationChecks",locations:e})}async scout(e,t=0){if(!this.authenticated)throw new M("Cannot scout locations while not connected and authenticated.");e=e.filter(n=>this.room.allLocations.includes(n));const[s]=await this.socket.send({cmd:"LocationScouts",create_as_hint:t,locations:e}).wait("locationInfo",n=>n.locations.map(o=>o.location).toSorted().join(",")===e.toSorted().join(","));return s.locations.map(n=>new V(this,n,this.players.self,this.players.findPlayer(n.player)))}bounce(e,t){if(!this.authenticated)throw new M("Cannot send bounces while not connected and authenticated.");this.socket.send({cmd:"Bounce",data:t,games:e.games??[],slots:e.slots??[],tags:e.tags??[]})}}at=new WeakMap,L=new WeakMap,kt=new WeakMap,Ct=new WeakMap;function Xt(){return new Promise((a,e)=>{const t=indexedDB.open("StickRangerAP",1);t.onupgradeneeded=()=>t.result.createObjectStore("savegames"),t.onsuccess=()=>a(t.result),t.onerror=()=>e(t.error)})}async function qt(a){const e=await Xt();return new Promise((t,s)=>{const o=e.transaction("savegames","readonly").objectStore("savegames").get(a);o.onsuccess=()=>t(o.result),o.onerror=()=>s(o.error)})}async function Pe(a,e){const t=await Xt();return new Promise((s,n)=>{const o=t.transaction("savegames","readwrite");o.objectStore("savegames").put(e,a),o.oncomplete=()=>s(),o.onerror=()=>n(o.error)})}class Ie{constructor(){this.STAGE_COMPLETE_OFFSET=1e4,this.BOOK_OFFSET=10100,this.LOC_OFFSET=11e3,this.ITEM_OFFSET=12e3,this.INV_START=16,this.MOUSE_SLOT=40,this.STAGE_TO_WIN=88,this._pendingConnect=!1,this._connected=!1,this.receivedItems=[],this.pendingItems=[],this.prevStage=[...Stage_Status],this.winReported=!1,this.lastSequence=-1,this.storageKey="",this.sendShopHints=!1,this.isScouting=!1,this.excludedBookStages=[0,20,47,70,77],this.bookHints={},this.randomizedBookCosts={},this.slotData={},this.host=document.getElementById("host"),this.port=document.getElementById("port"),this.slotName=document.getElementById("slotName"),this.password=document.getElementById("password"),this.connect=document.getElementById("connect"),this.chat=document.getElementById("chat"),this.apDiv=document.getElementById("APConnection"),this.connect.addEventListener("click",()=>this._onConnectClick()),window.addEventListener("beforeunload",()=>this._onUnload()),this._tick=this._tick.bind(this),requestAnimationFrame(this._tick)}async _onConnectClick(){this.storageKey=[this.host.value,this.port.value,"Stick Ranger",this.slotName.value].join(":");const e=await qt(this.storageKey);e&&(this.receivedItems=e.receivedItems,this.bookHints=e.bookHints??{},this.randomizedBookCosts=e.randomizedBookCosts??{},GameLoad(e.save.replace(/\r\n|\r|\n/g,""))),this._pendingConnect=!0,this.apDiv.style.display="none",this.log("Waiting for the game to enter the map...","info")}log(e,t="info"){const s=document.createElement("div");s.textContent=e,t==="error"&&(s.style.color="red"),this.chat.append(s),this.chat.scrollTop=this.chat.scrollHeight}async saveState(){this.storageKey&&await Pe(this.storageKey,{receivedItems:this.receivedItems,stages:Stage_Status,save:GameSave("0"),bookHints:this.bookHints??{},randomizedBookCosts:this.randomizedBookCosts??{}})}_onUnload(){var e;(e=this.client)==null||e.socket.disconnect()}restoreStagesBeaten(e){for(let t=0;t<e.length;t++)Stage_Status[t]|=e[t];return antiCheatSet(),Stage_Status}createRandomizedBookCosts(e){const t={},s=Stage_Status.length;switch(e){case 1:{for(let n=0;n<s;n++){const o=100*n,c=4e3*n,f=Math.pow(Math.random(),1.5),u=o+f*(c-o);t[n]=Math.max(1,Math.floor(u))}return t}case 2:{for(let n=0;n<s;n++)t[n]=Math.floor(Math.random()*99999)+1;return t}case 3:{for(let n=0;n<s;n++)t[n]=Math.floor(Math.random()*999999)+1;return t}case 0:default:return{}}}isEmpty(e){for(const t in e)if(Object.hasOwn(e,t))return!1;return!0}async _connect(){var f;this.client=new Ce;const e=this.host.value,t=parseInt(this.port.value),s="Stick Ranger",n=this.slotName.value,o=this.password.value,c=`${e}:${t}`;this.storageKey=[e,t,s,n].join(":"),this.client.socket.on("receivedItems",async u=>{if(console.log(u),u.items.length>1||u.items.length===1&&u.items[0].item===this.receivedItems[0]){const y=u.items.map(m=>m.item);for(const m of y)await this._applyItem(m,!1);let b=y.filter(m=>!this.receivedItems.includes(m));for(const m of b)await this._applyItem(m,!0)}else await this._applyItem(u.items[0].item,!0)}),this.client.socket.on("locationInfo",u=>{u.locations.forEach(y=>{if(y.location>=this.BOOK_OFFSET&&y.location<this.BOOK_OFFSET+100){const b=y.location-this.BOOK_OFFSET;this.bookHints[b]={player:this.client.players.findPlayer(y.player).name,item:this.client.package.lookupItemName(this.client.players.findPlayer(y.player).game,y.item),itemClassification:y.flags}}})}),this.client.socket.on("printJSON",u=>{const y=document.createElement("div");if(u.item){const b=u.item.player;u.data.forEach(m=>{var ct;const g=document.createElement("span");if(m.type==="player_id"){const jt=Number(m.text);g.textContent=(ct=this.client.players.findPlayer(jt))==null?void 0:ct.name,jt===b?g.style.color="#ee00ee":g.style.color="#eee8cd"}else if(m.type==="item_id")switch(g.textContent=this.client.package.lookupItemName(this.client.players.findPlayer(m.player).game,Number(m.text)),u.item.flags){case 1:g.style.color="#9f79ee";break;case 2:g.style.color="#4f94cd";break;case 4:g.style.color="#ed7b6e";break;case 0:default:g.style.color="#09cbcb";break}else m.type==="location_id"?(g.textContent=this.client.package.lookupLocationName(this.client.players.findPlayer(m.player).game,Number(m.text)),g.style.color="limegreen"):m.text&&(g.textContent=m.text);y.appendChild(g)})}else{const b=document.createElement("span");b.textContent=u.data[0].text,y.appendChild(b)}this.chat.appendChild(y),this.chat.scrollTop=this.chat.scrollHeight}),this.client.socket.on("connectionRefused",u=>{u.errors.forEach(y=>{this.log(y+"; please verify your connection settings.","error")})});try{const u=await qt(this.storageKey);u?(this.receivedItems=u.receivedItems,Stage_Status=this.restoreStagesBeaten(u.stages)):await this.saveState(),this.slotData=await this.client.login(c,n,s,{password:o,itemsHandlingFlags:Ut.all,tags:["AP"],slotData:!0}),this._connected=!0;const y=this.slotData.gold_multiplier??1;window.ArchipelagoMod.goldMultiplier=y;const b=this.slotData.xp_multiplier??1;window.ArchipelagoMod.xpMultiplier=b;const m=this.slotData.drop_multiplier??1;window.ArchipelagoMod.dropMultiplier=m,this.sendShopHints=this.slotData.shop_hints??!1,window.ArchipelagoMod.bookHintSpoiler=this.bookHints??{};const g=this.slotData.randomize_book_costs??0;window.ArchipelagoMod.bookCostRandomizer=g,this.isEmpty(this.randomizedBookCosts)&&(this.randomizedBookCosts=this.createRandomizedBookCosts(g)),window.ArchipelagoMod.randomizedBookCosts=this.randomizedBookCosts??{},antiCheatSet()}catch(u){Array.isArray(u)&&((f=u[0])==null?void 0:f.target)instanceof WebSocket?this.log("Cannot connect to: "+u[0].target.url+" Please check the hostname and port, or the server's online status.","error"):this.log("Unknown error during connection: "+u,"error"),this._connected=!1,Sequence_Step=0,this.apDiv.style.display="flex"}}async sendLocation(e){this.client.check(e),await this.saveState()}async _applyItem(e,t){if(t&&this.receivedItems.push(e),e>=this.LOC_OFFSET&&e<this.LOC_OFFSET+999)Stage_Status[e-this.LOC_OFFSET]|=Unlocked;else if(e>=this.ITEM_OFFSET&&e<this.ITEM_OFFSET+999&&t){const s=e-this.ITEM_OFFSET,n=this._firstEmptyInvSlot();n>=0?Item_Inv[n]=s:this.pendingItems.push(s)}antiCheatSet(),await this.saveState()}_firstEmptyInvSlot(){for(let e=this.INV_START;e<Item_Inv.length;e++)if(e!==this.MOUSE_SLOT&&!Item_Inv[e])return e;return-1}async _flushPending(){let e;for(;this.pendingItems.length&&(e=this._firstEmptyInvSlot())>=0;)Item_Inv[e]=this.pendingItems.shift(),await this.saveState(),antiCheatSet()}async scoutBooksOnShopOpen(){for(let e=0;e<Stage_Status.length;e++)this.excludedBookStages.includes(e)||Stage_Status[e]===3&&!this.bookHints[e]&&this.client.scout([this.BOOK_OFFSET+e],2);await this.saveState()}_tick(){this._doTickWork().catch(e=>{console.error("Tick error:",e)}),requestAnimationFrame(this._tick)}async _doTickWork(){var e,t;if(this._connected){for(let s=0;s<Stage_Status.length;s++)(this.prevStage[s]&Beaten)===0&&(Stage_Status[s]&Beaten)!==0&&await this.sendLocation(s+this.STAGE_COMPLETE_OFFSET),(this.prevStage[s]&Booked)===0&&(Stage_Status[s]&Booked)!==0&&await this.sendLocation(s+10100);this.prevStage=[...Stage_Status],await this._flushPending(),!this.winReported&&(Stage_Status[this.STAGE_TO_WIN]&Beaten)===Beaten&&(this.winReported=!0,(e=this.client)==null||e.goal()),Sequence_Step===54&&!this.isScouting&&this.sendShopHints&&(this.isScouting=!0,this.scoutBooksOnShopOpen()),Sequence_Step!==54&&this.isScouting&&(this.isScouting=!1)}Sequence_Step===6&&this.lastSequence===4&&((t=this.client)==null||t.socket.send({cmd:"Sync"})),Sequence_Step===6&&this._pendingConnect&&!this._connected&&(this._pendingConnect=!1,this._connect()),this.lastSequence=Sequence_Step}}window.ap=new Ie;
