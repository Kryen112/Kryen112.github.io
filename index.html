<!DOCTYPE html>
<html>
    <head>
        <title>Archipelago - Stick Ranger</title>
        <style>
            #cv:-webkit-full-screen {
                image-rendering: pixelated;
                image-rendering: -moz-crisp-edges;
                image-rendering: crisp-edges;
                -ms-interpolation-mode: nearest-neighbor;
                background-color: black;
                object-fit: contain;
                position: fixed;
                width: 100%;
                height: 100%;
            }

            body {
                background-color: #0f0f0f;
                overflow: hidden;
                display: flex;
            }

            html,
            body {
                height: 100%;
                margin: 0;
            }

            .left-panel {
                float: left;
            }

            .right-panel {
                float: right;
                width: 512px;
                background-color: rgb(51, 51, 51);
                color: white;
                display: flex;
                flex-direction: column;
                align-items: center;
                border-radius: 10px;
                margin: 10px;
            }

            #saveCode {
                width: 512px;
            }

            #APConnection {
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            #chat {
                flex: 1;
                width: 500px;
                border: 2px solid rgb(76, 76, 76);
                border-radius: 10px;
                overflow-y: auto;
                padding: 4px;
                font-family: monospace;
                font-size: 0.9em;
            }
        </style>
    </head>

    <body>
        <div class="left-panel">
            <div id="disable_electron_warnings">
                <script type="text/javascript">
                    process.env["ELECTRON_DISABLE_SECURITY_WARNINGS"] = "true";
                </script>
            </div>
            <canvas id="cv"></canvas>
            <script src="Archipelago Mod.js"></script>
            <script type="text/javascript">
                Init("1", 1, 0);
            </script>
            <div id="saveCode" style="width: 512px">
                <script type="text/javascript">
                    function saveCode() {
                        var save_html = "";
                        save_html += '<table class="ctbl"><tr><td><textarea id="inputBox" rows="1" cols="48" onclick="this.select();"><\/textarea><\/td>';
                        save_html += '<td><input type="submit" value="Get" onclick="getCode()" onmousedown="document.getElementById(\'inputBox\').value=\'\';">';
                        save_html += '<input type="submit" value="Set" onclick="load()";><\/td><\/tr><br>';

                        document.getElementById("saveCode").innerHTML = save_html;
                    }
                    saveCode();
                </script>
                <script type="text/javascript">
                    function getCode() {
                        var save_string = GameSave("0");

                        if (save_string != "") document.getElementById("inputBox").value = save_string;
                    }

                    function load() {
                        document.getElementById("inputBox").value = document.getElementById("inputBox").value.replace(/\x0D\x0A|\x0D|\x0A/g, "");
                        var save_string = document.getElementById("inputBox").value;

                        if (save_string != "") GameLoad(save_string);
                    }
                </script>
            </div>
            <div id="fullScreenButton">
                <input type="submit" value="Full Screen" onclick="fullScreen();" />
            </div>
        </div>

        <div class="right-panel">
            <div id="APConnection">
                <p>Archipelago connection</p>
                <table>
                    <tr>
                        <td>Host:</td>
                        <td><input type="text" id="host" placeholder="archipelago.gg" value="archipelago.gg" /></td>
                    </tr>
                    <tr>
                        <td>Port:</td>
                        <td><input type="text" id="port" placeholder="35556" /></td>
                    </tr>
                    <tr>
                        <td>Slot name:</td>
                        <td><input type="text" id="slotName" placeholder="Slot name" /></td>
                    </tr>
                    <tr>
                        <td>Password:</td>
                        <td><input type="password" id="password" /></td>
                    </tr>
                </table>
                <button id="connect">Connect</button>
            </div>
            <div id="chat"></div>

            <script type="module">
                import { Client, ITEMS_HANDLING_FLAGS, SERVER_PACKET_TYPE, CLIENT_STATUS, CLIENT_PACKET_TYPE } from "https://unpkg.com/archipelago.js@1.0.0/dist/archipelago.js";

                // --- IndexedDB helpers ---
                function openDB() {
                    return new Promise((res, rej) => {
                        const req = indexedDB.open("StickRangerAP", 1);
                        req.onupgradeneeded = () => req.result.createObjectStore("savegames");
                        req.onsuccess = () => res(req.result);
                        req.onerror = () => rej(req.error);
                    });
                }

                async function getState(key) {
                    const db = await openDB();
                    return new Promise((res, rej) => {
                        const tx = db.transaction("savegames", "readonly");
                        const req = tx.objectStore("savegames").get(key);
                        req.onsuccess = () => res(req.result);
                        req.onerror = () => rej(req.error);
                    });
                }

                async function setState(key, val) {
                    const db = await openDB();
                    return new Promise((res, rej) => {
                        const tx = db.transaction("savegames", "readwrite");
                        tx.objectStore("savegames").put(val, key);
                        tx.oncomplete = () => res();
                        tx.onerror = () => rej(tx.error);
                    });
                }
                // ---------------------------

                class APIntegration {
                    constructor() {
                        this.STAGE_COMPLETE_OFFSET = 10000;
                        this.BOOK_OFFSET = 10100;
                        this.LOC_OFFSET = 11000;
                        this.ITEM_OFFSET = 12000;
                        this.INV_START = 16;
                        this.MOUSE_SLOT = 40;
                        this.STAGE_TO_WIN = 88; // Hell Castle ID

                        this._pendingConnect = false;
                        this._connected = false;
                        this.receivedItems = [];
                        this.pendingItems = [];
                        this.prevStage = [...Stage_Status];
                        this.winReported = false;
                        this.lastSequence = -1;
                        this.storageKey = "";

                        this.host = document.getElementById("host");
                        this.port = document.getElementById("port");
                        this.slotName = document.getElementById("slotName");
                        this.password = document.getElementById("password");
                        this.connect = document.getElementById("connect");
                        this.chat = document.getElementById("chat");
                        this.apDiv = document.getElementById("APConnection");

                        this.connect.addEventListener("click", () => this._onConnectClick());
                        window.addEventListener("beforeunload", async () => await this._onUnload()); //TODO this is now saync and it could break, look chatgpt
                        this._tick = this._tick.bind(this);
                        requestAnimationFrame(this._tick);
                    }

                    async _onConnectClick() {
                        this.storageKey = [this.host.value, this.port.value, "Stick Ranger", this.slotName.value].join(":");

                        const saved = await getState(this.storageKey);
                        if (saved) {
                            this.receivedItems = saved.receivedItems;
                            GameLoad(saved.save.replace(/\r\n|\r|\n/g, ""));
                        }

                        this._pendingConnect = true;
                        this.apDiv.style.display = "none";
                        this.log("Waiting for the game to enter the map...", "info");
                    }

                    log(msg, type = "info") {
                        const container = document.createElement("div");
                        container.textContent = msg;
                        if (type === "error") {
                            container.style.color = "red";
                        }
                        this.chat.append(container);
                        this.chat.scrollTop = this.chat.scrollHeight;
                    }

                    async saveState() {
                        if (!this.storageKey) return;
                        await setState(this.storageKey, {
                            receivedItems: this.receivedItems,
                            stages: Stage_Status,
                            save: GameSave("0"),
                        });
                    }

                    async _onUnload() {
                        await this.saveState();
                        this.client?.disconnect();
                    }

                    restoreStagesBeaten(savedStages) {
                        for (let i = 0; i < savedStages.length; i++) {
                            Stage_Status[i] |= savedStages[i];
                        }
                        antiCheatSet();
                        return Stage_Status;
                    }

                    async _connect() {
                        this.client = new Client();
                        const connectionInfo = {
                            hostname: this.host.value,
                            port: parseInt(this.port.value),
                            game: "Stick Ranger",
                            name: this.slotName.value,
                            password: this.password.value,
                            items_handling: ITEMS_HANDLING_FLAGS.REMOTE_ALL,
                        };

                        this.storageKey = [connectionInfo.hostname, connectionInfo.port, connectionInfo.game, connectionInfo.name].join(":");

                        this.client.addListener(SERVER_PACKET_TYPE.CONNECTED, async () => {
                            const saved = await getState(this.storageKey);
                            if (saved) {
                                this.receivedItems = saved.receivedItems;
                                Stage_Status = this.restoreStagesBeaten(saved.stages);
                            } else {
                                await this.saveState();
                            }

                            const goldMultiplier = this.client.data.slotData.gold_multiplier ?? 1;
                            window.ArchipelagoMod.goldMultiplier = goldMultiplier;
                            const xpMultiplier = this.client.data.slotData.xp_multiplier ?? 1;
                            window.ArchipelagoMod.xpMultiplier = xpMultiplier;
                            const dropMultiplier = this.client.data.slotData.drop_multiplier ?? 1;
                            window.ArchipelagoMod.dropMultiplier = dropMultiplier;
                        });

                        this.client.addListener(SERVER_PACKET_TYPE.RECEIVED_ITEMS, async (packet) => {
                            if (packet.items.length > 1 || (packet.items.length === 1 && packet.items[0].item === this.receivedItems[0])) {
                                const serverItems = packet.items.map((i) => i.item);

                                for (const id of serverItems) {
                                    await this._applyItem(id, false);
                                }

                                let difference = serverItems.filter((item) => !this.receivedItems.includes(item));
                                for (const id of difference) {
                                    await this._applyItem(id, true);
                                }
                            } else {
                                await this._applyItem(packet.items[0].item, true);
                            }
                        });

                        this.client.addListener(SERVER_PACKET_TYPE.PRINT_JSON, (packet) => {
                            const container = document.createElement("div");
                            const connectedPlayerId = Number(this.client.data.slotData.player_id);
                            packet.data.forEach(el => {
                                const span = document.createElement("span");
                                const forPlayer = el.player ?? connectedPlayerId;
                                if (el.type === "player_id") {
                                    const pid = Number(el.text);
                                    span.textContent = this.client.players.name(pid);
                                    if (pid === connectedPlayerId) {
                                        span.style.color = "fuchsia";
                                    } else {
                                        span.style.color = "#eee8cd";
                                    }
                                } else if (el.type === "item_id") {
                                    span.textContent = this.client.items.name(this.client.players.game(forPlayer), Number(el.text));
                                    switch (packet.item.flags) {
                                        case 1: // Progression
                                            span.style.color = "#9f79ee";
                                            break;
                                        case 2: // Useful
                                            span.style.color = "#4f94cd";
                                            break;
                                        case 4: // Trap
                                            span.style.color = "#ed7b6e";
                                            break;
                                        case 0: // Filler
                                        default:
                                            span.style.color = "#09cbcb";
                                            break;
                                    }
                                } else if (el.type === "location_id") {
                                    span.textContent = this.client.locations.name(this.client.players.game(forPlayer), Number(el.text));
                                    span.style.color = "limegreen";
                                } else if (el.text) {
                                    span.textContent = el.text;
                                }
                                container.appendChild(span);
                            });

                            this.chat.appendChild(container);
                            this.chat.scrollTop = this.chat.scrollHeight;
                        });

                        this.client.addListener(SERVER_PACKET_TYPE.CONNECTION_REFUSED, (packet) => {
                            packet.errors.forEach(error => {
                                this.log(error + "; please verify your connection settings.", "error");
                            });
                        });

                        try {
                            await this.client.connect(connectionInfo);
                            this._connected = true;
                        } catch (error) {
                            if (Array.isArray(error) && error[0]?.target instanceof WebSocket) {
                                this.log("Cannot connect to: " + error[0].target.url + " Please check the hostname and port, or the server's online status.", "error");
                            } else {
                                this.log("Unknown error during connection: " + error, "error");
                            }
                            this._connected = false;
                            Sequence_Step = 0;
                            this.apDiv.style.display = "flex";
                        }
                    }

                    async sendLocation(id) {
                        if (this.client) this.client.locations.check(id);
                        await this.saveState();
                    }

                    async _applyItem(id, firstTime) {
                        if (firstTime) {
                            this.receivedItems.push(id);
                        }

                        // location unlock
                        if (id >= this.LOC_OFFSET && id < this.LOC_OFFSET + 999) {
                            Stage_Status[id - this.LOC_OFFSET] |= Unlocked;
                        }

                        // item grant
                        else if (id >= this.ITEM_OFFSET && id < this.ITEM_OFFSET + 999 && firstTime) {
                            const idx = id - this.ITEM_OFFSET;
                            const slot = this._firstEmptyInvSlot();
                            if (slot >= 0) Item_Inv[slot] = idx;
                            else this.pendingItems.push(idx);
                        }

                        antiCheatSet();
                        await this.saveState();
                    }

                    _firstEmptyInvSlot() {
                        for (let i = this.INV_START; i < Item_Inv.length; i++) {
                            if (i === this.MOUSE_SLOT) continue;
                            if (!Item_Inv[i]) return i;
                        }
                        return -1;
                    }

                    async _flushPending() {
                        let slot;
                        while (this.pendingItems.length && (slot = this._firstEmptyInvSlot()) >= 0) {
                            Item_Inv[slot] = this.pendingItems.shift();
                            await this.saveState();
                            antiCheatSet();
                        }
                    }

                    _tick() {
                        // fire off the async work, but catch errors so the loop never dies
                        this._doTickWork().catch((err) => {
                            console.error("Tick error:", err);
                        });

                        requestAnimationFrame(this._tick);
                    }

                    async _doTickWork() {
                        //TODO this is now saync and it could break, look chatgpt
                        // scan beaten/booked changes
                        for (let i = 0; i < Stage_Status.length; i++) {
                            if ((this.prevStage[i] & Beaten) === 0 && (Stage_Status[i] & Beaten) !== 0) {
                                await this.sendLocation(i + this.STAGE_COMPLETE_OFFSET);
                            }
                            if ((this.prevStage[i] & Booked) === 0 && (Stage_Status[i] & Booked) !== 0) {
                                await this.sendLocation(i + 10100);
                            }
                        }
                        this.prevStage = [...Stage_Status];

                        // flush inventory
                        await this._flushPending();

                        // report win
                        if (!this.winReported && (Stage_Status[this.STAGE_TO_WIN] & Beaten) === Beaten) {
                            this.winReported = true;
                            this.client?.send({
                                cmd: "StatusUpdate",
                                status: 30,
                            });
                        }

                        // on "new game", give everything
                        if (Sequence_Step === 6 && this.lastSequence === 4) {
                            this.client?.send({
                                cmd: CLIENT_PACKET_TYPE.SYNC,
                            });
                        }

                        // connect once game is properly loaded
                        if (Sequence_Step === 6 && this._pendingConnect && !this._connected) {
                            this._pendingConnect = false;
                            this._connect();
                        }

                        this.lastSequence = Sequence_Step;
                    }
                }

                window.ap = new APIntegration();
            </script>
        </div>
    </body>
</html>
